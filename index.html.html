<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="theme-color" content="#1b5e20">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>KemetChem Pro - Ù†Ø¸Ø§Ù… Ø§Ù„Ù…Ù†Ø¯ÙˆØ¨ÙŠÙ† Ø§Ù„Ù…ØªÙƒØ§Ù…Ù„</title>
    
    <!-- Supabase SDK -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <!-- Other Libraries -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/idb/7.1.1/index.min.js"></script>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    
    <style>
        :root {
            --primary: #1b5e20;
            --primary-light: #2e7d32;
            --primary-dark: #0d3b10;
            --secondary: #f39c12;
            --danger: #e74c3c;
            --success: #27ae60;
            --info: #3498db;
            --warning: #f1c40f;
            --dark: #1a1a1a;
            --light: #f1f8e9;
            --white: #ffffff;
            --purple: #6a1b9a;
            --shadow-sm: 0 2px 4px rgba(0,0,0,0.1);
            --shadow-md: 0 4px 6px rgba(0,0,0,0.1);
            --shadow-lg: 0 10px 15px rgba(0,0,0,0.1);
            --radius-sm: 8px;
            --radius-md: 12px;
            --radius-lg: 16px;
            --radius-xl: 24px;
            --safe-area-top: env(safe-area-inset-top, 0px);
            --safe-area-bottom: env(safe-area-inset-bottom, 0px);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', 'Tahoma', 'Geneva', 'Verdana', sans-serif;
            -webkit-tap-highlight-color: transparent;
            -webkit-touch-callout: none;
            -webkit-user-select: none;
            user-select: none;
        }

        html {
            height: 100%;
            overflow: hidden;
        }

        body {
            background: linear-gradient(135deg, #e8f5e9 0%, #c8e6c9 100%);
            height: 100%;
            overflow: hidden;
            position: fixed;
            width: 100%;
        }

        /* Loading Screen */
        .app-loader {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-light) 100%);
            z-index: 9999;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            transition: opacity 0.5s, visibility 0.5s;
        }

        .app-loader.hidden {
            opacity: 0;
            visibility: hidden;
        }

        .loader-content {
            text-align: center;
            color: white;
        }

        .loader-logo {
            width: 140px;
            height: 140px;
            background: rgba(255,255,255,0.15);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 70px;
            margin-bottom: 24px;
            animation: pulse 2s infinite;
            backdrop-filter: blur(10px);
            border: 4px solid rgba(255,255,255,0.2);
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }

        /* Header */
        .app-header {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-light) 100%);
            color: white;
            padding: calc(12px + var(--safe-area-top)) 16px 12px;
            position: fixed;
            top: 0;
            width: 100%;
            z-index: 1000;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: var(--shadow-lg);
            height: calc(65px + var(--safe-area-top));
        }

        .header-title {
            text-align: center;
            flex: 1;
        }

        .header-title h1 {
            font-size: 22px;
            font-weight: 700;
            margin: 0;
        }

        .header-title p {
            font-size: 12px;
            opacity: 0.9;
            margin: 2px 0 0;
        }

        .menu-btn {
            background: rgba(255,255,255,0.15);
            border: none;
            color: white;
            width: 44px;
            height: 44px;
            border-radius: var(--radius-md);
            cursor: pointer;
            font-size: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            touch-action: manipulation;
            transition: all 0.2s;
        }

        /* Connection Status */
        .connection-status {
            position: fixed;
            top: calc(65px + var(--safe-area-top));
            left: 0;
            right: 0;
            padding: 8px 16px;
            text-align: center;
            font-size: 13px;
            font-weight: 600;
            z-index: 999;
            transform: translateY(-100%);
            transition: transform 0.3s;
        }

        .connection-status.online { background: var(--success); color: white; transform: translateY(0); }
        .connection-status.offline { background: var(--danger); color: white; transform: translateY(0); }
        .connection-status.syncing { background: var(--info); color: white; transform: translateY(0); }

        /* Side Nav */
        .side-nav {
            position: fixed;
            top: 0;
            right: 0;
            width: 85%;
            max-width: 340px;
            height: 100vh;
            background: rgba(255, 255, 255, 0.98);
            z-index: 2000;
            transform: translateX(100%);
            transition: transform 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            overflow-y: auto;
            box-shadow: -10px 0 40px rgba(0,0,0,0.2);
            padding-bottom: var(--safe-area-bottom);
        }

        .side-nav.active { transform: translateX(0); }

        .nav-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.6);
            z-index: 1500;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s;
            backdrop-filter: blur(4px);
        }

        .nav-overlay.active { opacity: 1; visibility: visible; }

        .nav-header {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-light) 100%);
            padding: calc(24px + var(--safe-area-top)) 24px 24px;
            color: white;
            position: relative;
        }

        .nav-logo {
            width: 80px;
            height: 80px;
            background: rgba(255,255,255,0.2);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 40px;
            margin-bottom: 16px;
        }

        .nav-stats {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
            margin-top: 20px;
        }

        .nav-stat {
            background: rgba(255,255,255,0.15);
            padding: 12px;
            border-radius: var(--radius-md);
            text-align: center;
        }

        .nav-stat-value { font-size: 20px; font-weight: bold; }
        .nav-stat-label { font-size: 11px; opacity: 0.9; }

        .nav-items { padding: 16px 0; }

        .nav-item {
            padding: 16px 24px;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 15px;
            display: flex;
            align-items: center;
            gap: 16px;
            border-right: 3px solid transparent;
        }

        .nav-item:hover {
            background: linear-gradient(90deg, rgba(27,94,32,0.08) 0%, transparent 100%);
            border-right-color: var(--primary);
        }

        .nav-item-icon {
            width: 44px;
            height: 44px;
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-light) 100%);
            border-radius: var(--radius-md);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 20px;
        }

        /* Main Content */
        .main-content {
            margin-top: calc(65px + var(--safe-area-top));
            padding: 16px;
            padding-bottom: calc(24px + var(--safe-area-bottom));
            height: calc(100vh - 65px - var(--safe-area-top));
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
        }

        .section {
            display: none;
            opacity: 0;
            transform: translateY(20px);
            transition: opacity 0.3s, transform 0.3s;
        }

        .section.active {
            display: block;
            opacity: 1;
            transform: translateY(0);
        }

        /* Cards */
        .card {
            background: var(--white);
            border-radius: var(--radius-lg);
            padding: 24px;
            margin-bottom: 16px;
            box-shadow: var(--shadow-md);
            border: 1px solid rgba(0,0,0,0.05);
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .card-title {
            font-size: 18px;
            font-weight: 700;
            color: var(--dark);
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .card-icon {
            width: 44px;
            height: 44px;
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-light) 100%);
            border-radius: var(--radius-md);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 22px;
        }

        /* Buttons */
        .btn {
            padding: 16px 24px;
            border: none;
            border-radius: var(--radius-md);
            cursor: pointer;
            font-size: 15px;
            font-weight: 600;
            width: 100%;
            margin-bottom: 12px;
            touch-action: manipulation;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            min-height: 52px;
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-light) 100%);
            color: white;
            box-shadow: 0 4px 15px rgba(27, 94, 32, 0.3);
        }

        .btn-success {
            background: linear-gradient(135deg, var(--success) 0%, #2ecc71 100%);
            color: white;
        }

        .btn-danger {
            background: linear-gradient(135deg, var(--danger) 0%, #c0392b 100%);
            color: white;
        }

        .btn-warning {
            background: linear-gradient(135deg, var(--secondary) 0%, #e67e22 100%);
            color: white;
        }

        .btn-purple {
            background: linear-gradient(135deg, var(--purple) 0%, #9c27b0 100%);
            color: white;
        }

        .btn-info {
            background: linear-gradient(135deg, var(--info) 0%, #2980b9 100%);
            color: white;
        }

        .btn-sm { padding: 10px 16px; font-size: 13px; min-height: 40px; }

        .btn-row {
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
        }

        .btn-row .btn {
            flex: 1;
            min-width: 140px;
            margin-bottom: 0;
        }

        /* Forms */
        .form-group { margin-bottom: 24px; }

        .form-label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: var(--dark);
            font-size: 14px;
        }

        .form-control {
            width: 100%;
            padding: 16px;
            border: 2px solid #e0e0e0;
            border-radius: var(--radius-md);
            font-size: 16px;
            -webkit-appearance: none;
            background: var(--white);
            transition: all 0.2s;
        }

        .form-control:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 4px rgba(27, 94, 32, 0.1);
        }

        /* Stats Grid */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
            margin-bottom: 20px;
        }

        .stat-card {
            background: var(--white);
            padding: 20px;
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-md);
            border-top: 4px solid;
            position: relative;
        }

        .stat-card.sales { border-color: var(--success); }
        .stat-card.visits { border-color: var(--info); }
        .stat-card.credit { border-color: var(--danger); }
        .stat-card.payments { border-color: var(--secondary); }
        .stat-card.target { border-color: var(--purple); }

        .stat-icon {
            width: 48px;
            height: 48px;
            border-radius: var(--radius-md);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            margin-bottom: 12px;
        }

        .stat-card.sales .stat-icon { background: rgba(39, 174, 96, 0.1); color: var(--success); }
        .stat-card.visits .stat-icon { background: rgba(52, 152, 219, 0.1); color: var(--info); }
        .stat-card.credit .stat-icon { background: rgba(231, 76, 60, 0.1); color: var(--danger); }
        .stat-card.payments .stat-icon { background: rgba(243, 156, 18, 0.1); color: var(--secondary); }
        .stat-card.target .stat-icon { background: rgba(106, 27, 154, 0.1); color: var(--purple); }

        .stat-label { font-size: 13px; color: #7f8c8d; font-weight: 500; margin-bottom: 4px; }
        .stat-value { font-size: 26px; font-weight: 700; color: var(--dark); line-height: 1; }

        .progress-bar {
            width: 100%;
            height: 6px;
            background: #f0f0f0;
            border-radius: 3px;
            overflow: hidden;
            margin-top: 8px;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--primary) 0%, var(--primary-light) 100%);
            border-radius: 3px;
            transition: width 0.5s ease;
        }

        /* List Items */
        .list-container { display: flex; flex-direction: column; gap: 12px; }

        .list-item {
            background: var(--white);
            padding: 20px;
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-sm);
            border-right: 4px solid var(--primary);
            position: relative;
            transition: all 0.2s;
            cursor: pointer;
        }

        .list-item:hover { transform: translateX(-4px); box-shadow: var(--shadow-md); }

        .list-item-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 12px;
        }

        .list-item-title { font-size: 16px; font-weight: 700; color: var(--dark); flex: 1; }

        .list-item-badge {
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
        }

        .list-item-badge.cash { background: rgba(39, 174, 96, 0.1); color: var(--success); }
        .list-item-badge.credit { background: rgba(231, 76, 60, 0.1); color: var(--danger); }
        .list-item-badge.pending { background: rgba(243, 156, 18, 0.1); color: var(--secondary); }
        .list-item-badge.approved { background: rgba(39, 174, 96, 0.1); color: var(--success); }

        .list-item-meta {
            display: flex;
            flex-wrap: wrap;
            gap: 12px;
            font-size: 13px;
            color: #7f8c8d;
            margin-bottom: 12px;
        }

        .list-item-actions {
            display: flex;
            gap: 8px;
            margin-top: 16px;
        }

        .list-item-actions .btn { flex: 1; margin: 0; padding: 10px; font-size: 13px; }

        .item-actions {
            position: absolute;
            top: 16px;
            left: 16px;
            display: flex;
            gap: 8px;
        }

        .action-btn {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            border: none;
            cursor: pointer;
            font-size: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            transition: all 0.2s;
        }

        .action-btn.delete { background: var(--danger); }
        .action-btn.edit { background: var(--info); }
        .action-btn.map { background: var(--success); }

        /* Modal */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.8);
            z-index: 3000;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s;
            display: flex;
            align-items: flex-end;
            justify-content: center;
        }

        .modal.active { opacity: 1; visibility: visible; }

        .modal-content {
            background: var(--white);
            width: 100%;
            max-height: 90vh;
            border-radius: var(--radius-xl) var(--radius-xl) 0 0;
            overflow-y: auto;
            transform: translateY(100%);
            transition: transform 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .modal.active .modal-content { transform: translateY(0); }

        .modal-header {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-light) 100%);
            color: white;
            padding: calc(16px + var(--safe-area-top)) 20px 16px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .modal-title { font-size: 18px; font-weight: 700; display: flex; align-items: center; gap: 10px; }

        .modal-body { padding: 24px; }

        .modal-close {
            background: rgba(255,255,255,0.2);
            border: none;
            color: white;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        /* Search */
        .search-container { position: relative; margin-bottom: 20px; }

        .search-box { position: relative; }

        .search-input {
            width: 100%;
            padding: 16px 48px 16px 16px;
            border: 2px solid #e0e0e0;
            border-radius: var(--radius-xl);
            font-size: 16px;
            transition: all 0.2s;
            background: var(--white);
        }

        .search-icon {
            position: absolute;
            right: 16px;
            top: 50%;
            transform: translateY(-50%);
            color: #95a5a6;
            font-size: 20px;
        }

        /* Toast */
        .toast-container {
            position: fixed;
            bottom: calc(24px + var(--safe-area-bottom));
            left: 50%;
            transform: translateX(-50%);
            z-index: 5000;
            display: flex;
            flex-direction: column;
            gap: 8px;
            width: 90%;
            max-width: 400px;
        }

        .toast {
            background: #333;
            color: white;
            padding: 16px 24px;
            border-radius: var(--radius-lg);
            font-size: 14px;
            box-shadow: var(--shadow-lg);
            display: flex;
            align-items: center;
            gap: 12px;
            animation: slideUp 0.3s ease;
        }

        .toast.success { background: var(--success); }
        .toast.error { background: var(--danger); }
        .toast.warning { background: var(--secondary); }

        @keyframes slideUp {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* GPS Section */
        .gps-section {
            background: linear-gradient(135deg, #2e7d32 0%, #1b5e20 100%);
            padding: 24px;
            border-radius: var(--radius-lg);
            margin-top: 20px;
            color: white;
        }

        .gps-btn-main {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            color: white;
            border: none;
            padding: 20px;
            border-radius: var(--radius-lg);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
            width: 100%;
            font-size: 16px;
            font-weight: bold;
            box-shadow: 0 6px 20px rgba(245, 87, 108, 0.4);
            transition: all 0.3s;
            position: relative;
            overflow: hidden;
        }

        .gps-btn-main.loading { background: #95a5a6; pointer-events: none; }
        .gps-btn-main.success { background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%); }
        .gps-btn-main.error { background: linear-gradient(135deg, #eb3349 0%, #f45c43 100%); }

        .gps-status {
            margin-top: 16px;
            padding: 16px;
            background: rgba(255,255,255,0.2);
            border-radius: var(--radius-md);
            display: none;
        }

        .gps-status.active { display: flex; align-items: center; gap: 12px; }

        #staticMap {
            width: 100%;
            height: 220px;
            border-radius: var(--radius-lg);
            margin-top: 16px;
            display: none;
        }

        #staticMap.active { display: block; }

        /* KPI Dashboard */
        .kpi-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
            margin-bottom: 20px;
        }

        .kpi-card {
            background: white;
            border-radius: var(--radius-lg);
            padding: 16px;
            box-shadow: var(--shadow-sm);
            text-align: center;
        }

        .kpi-value {
            font-size: 28px;
            font-weight: bold;
            color: var(--primary);
            margin: 8px 0;
        }

        .kpi-label { font-size: 12px; color: #666; }

        .kpi-change {
            font-size: 11px;
            padding: 4px 8px;
            border-radius: 12px;
            display: inline-block;
            margin-top: 4px;
        }

        .kpi-change.positive { background: rgba(39, 174, 96, 0.1); color: var(--success); }
        .kpi-change.negative { background: rgba(231, 76, 96, 0.1); color: var(--danger); }

        /* Aging Report */
        .aging-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 14px;
            margin-top: 16px;
        }

        .aging-table th {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-light) 100%);
            color: white;
            padding: 12px;
            text-align: center;
        }

        .aging-table td {
            padding: 12px;
            border-bottom: 1px solid #eee;
            text-align: center;
        }

        .aging-badge {
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
        }

        .aging-30 { background: rgba(39, 174, 96, 0.1); color: var(--success); }
        .aging-60 { background: rgba(243, 156, 18, 0.1); color: var(--secondary); }
        .aging-90 { background: rgba(231, 76, 60, 0.1); color: var(--danger); }

        /* Route Planner */
        .route-card {
            background: white;
            border-radius: var(--radius-lg);
            padding: 20px;
            margin-bottom: 12px;
            box-shadow: var(--shadow-sm);
            border-right: 4px solid var(--info);
        }

        .route-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }

        .route-sequence {
            width: 36px;
            height: 36px;
            background: var(--info);
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 16px;
        }

        .route-distance {
            font-size: 13px;
            color: #666;
            display: flex;
            align-items: center;
            gap: 4px;
        }

        /* Geofencing Alert */
        .geofence-alert {
            position: fixed;
            bottom: 100px;
            left: 50%;
            transform: translateX(-50%) translateY(100px);
            background: var(--danger);
            color: white;
            padding: 16px 24px;
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-lg);
            z-index: 4000;
            opacity: 0;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .geofence-alert.active {
            transform: translateX(-50%) translateY(0);
            opacity: 1;
        }

        /* Company Selector */
        .company-selector {
            background: white;
            border-radius: var(--radius-lg);
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: var(--shadow-md);
        }

        .company-option {
            display: flex;
            align-items: center;
            gap: 16px;
            padding: 16px;
            border: 2px solid #e0e0e0;
            border-radius: var(--radius-md);
            margin-bottom: 12px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .company-option:hover, .company-option.active {
            border-color: var(--primary);
            background: rgba(27, 94, 32, 0.05);
        }

        .company-logo {
            width: 60px;
            height: 60px;
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-light) 100%);
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 28px;
        }

        /* Login Screen */
        .login-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-light) 100%);
            z-index: 10000;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 24px;
            overflow-y: auto;
        }

        .login-screen.hidden { display: none; }

        .login-container {
            background: white;
            border-radius: var(--radius-xl);
            padding: 40px 32px;
            width: 100%;
            max-width: 450px;
            box-shadow: var(--shadow-lg);
            text-align: center;
        }

        .login-logo {
            width: 100px;
            height: 100px;
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-light) 100%);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 50px;
            margin: 0 auto 24px;
            color: white;
        }

        .login-title { font-size: 28px; font-weight: bold; color: var(--dark); margin-bottom: 8px; }
        .login-subtitle { color: #666; margin-bottom: 32px; font-size: 14px; }

        .login-input {
            width: 100%;
            padding: 16px;
            border: 2px solid #e0e0e0;
            border-radius: var(--radius-md);
            font-size: 16px;
            margin-bottom: 16px;
            text-align: right;
            transition: all 0.2s;
        }

        .login-input:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 4px rgba(27, 94, 32, 0.1);
        }

        .login-btn {
            width: 100%;
            padding: 16px;
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-light) 100%);
            color: white;
            border: none;
            border-radius: var(--radius-md);
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        /* Sync Indicator */
        .sync-indicator {
            position: fixed;
            bottom: calc(24px + var(--safe-area-bottom));
            right: 24px;
            width: 56px;
            height: 56px;
            background: var(--primary);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 24px;
            box-shadow: var(--shadow-lg);
            cursor: pointer;
            z-index: 1000;
            transition: all 0.3s;
        }

        .sync-indicator.syncing { animation: rotate 1s linear infinite; }
        .sync-indicator.pending { background: var(--secondary); }
        .sync-indicator.error { background: var(--danger); }

        @keyframes rotate { to { transform: rotate(360deg); } }

        /* Rating Stars */
        .rating-stars {
            display: flex;
            gap: 8px;
            justify-content: center;
            margin: 16px 0;
        }

        .star {
            font-size: 32px;
            cursor: pointer;
            transition: all 0.2s;
            color: #ddd;
        }

        .star.active { color: #f1c40f; }
        .star:hover { transform: scale(1.2); }

        /* Payment Methods */
        .payment-methods {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
            margin: 16px 0;
        }

        .payment-method {
            padding: 16px;
            border: 2px solid #e0e0e0;
            border-radius: var(--radius-md);
            cursor: pointer;
            text-align: center;
            transition: all 0.2s;
        }

        .payment-method:hover, .payment-method.active {
            border-color: var(--primary);
            background: rgba(27, 94, 32, 0.05);
        }

        .payment-method-icon {
            font-size: 28px;
            margin-bottom: 8px;
        }

        /* Customer Rating Card */
        .customer-rating {
            background: linear-gradient(135deg, #f5f5f5 0%, #e0e0e0 100%);
            padding: 16px;
            border-radius: var(--radius-md);
            margin-top: 16px;
        }

        .rating-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 0;
            border-bottom: 1px solid #ddd;
        }

        .rating-item:last-child { border-bottom: none; }

        /* Suggested Customers Section */
        .suggested-customers {
            background: linear-gradient(135deg, #fff3e0 0%, #ffe0b2 100%);
            border: 2px solid var(--secondary);
            border-radius: var(--radius-lg);
            padding: 20px;
            margin-bottom: 20px;
        }

        .suggested-badge {
            background: var(--secondary);
            color: white;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            display: inline-block;
            margin-bottom: 12px;
        }

        /* Region Selector */
        .region-selector {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
            margin-bottom: 20px;
        }

        .region-option {
            padding: 16px;
            border: 2px solid #e0e0e0;
            border-radius: var(--radius-md);
            cursor: pointer;
            text-align: center;
            transition: all 0.2s;
        }

        .region-option:hover, .region-option.active {
            border-color: var(--primary);
            background: rgba(27, 94, 32, 0.05);
        }

        /* Responsive */
        @media (min-width: 768px) {
            .stats-grid, .kpi-grid { grid-template-columns: repeat(4, 1fr); }
            .side-nav { width: 340px; }
        }

        /* Print */
        @media print {
            .no-print, .app-header, .sync-indicator { display: none !important; }
            .main-content { margin-top: 0; height: auto; overflow: visible; }
        }

        /* Dark Mode */
        @media (prefers-color-scheme: dark) {
            :root { --white: #1e1e1e; }
            body {
                background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
                color: #fff;
            }
            .card, .list-item, .stat-card { background: #2d2d2d; color: #fff; }
            .form-control { background: #2d2d2d; color: #fff; border-color: #444; }
        }
    </style>
</head>
<body>
    <!-- Login Screen -->
    <div class="login-screen" id="loginScreen">
        <div class="login-container">
            <div class="login-logo">ğŸŒ¾</div>
            <div class="login-title">KemetChem Pro</div>
            <div class="login-subtitle">Ù†Ø¸Ø§Ù… Ø§Ù„Ù…Ù†Ø¯ÙˆØ¨ÙŠÙ† Ø§Ù„Ø§Ø­ØªØ±Ø§ÙÙŠ</div>
            
            <!-- Company Selection -->
            <div id="companySelection" style="margin-bottom: 24px;">
                <div style="font-size: 14px; color: #666; margin-bottom: 12px;">Ø§Ø®ØªØ± Ø§Ù„Ø´Ø±ÙƒØ©</div>
                <div id="companiesList"></div>
            </div>

            <div class="login-tabs" style="display: flex; gap: 8px; margin-bottom: 24px; background: #f5f5f5; padding: 4px; border-radius: var(--radius-lg);">
                <button class="login-tab active" onclick="switchLoginTab('rep')" style="flex: 1; padding: 12px; border: none; background: white; border-radius: var(--radius-md); cursor: pointer; font-weight: 600;">ğŸ‘¤ Ù…Ù†Ø¯ÙˆØ¨</button>
                <button class="login-tab" onclick="switchLoginTab('manager')" style="flex: 1; padding: 12px; border: none; background: transparent; border-radius: var(--radius-md); cursor: pointer; font-weight: 600; color: #666;">ğŸ‘” Ù…Ø¯ÙŠØ±</button>
                <button class="login-tab" onclick="switchLoginTab('admin')" style="flex: 1; padding: 12px; border: none; background: transparent; border-radius: var(--radius-md); cursor: pointer; font-weight: 600; color: #666;">âš™ï¸ Ø£Ø¯Ù…Ù†</button>
            </div>

            <!-- Rep Registration Form (Initial) -->
            <div id="repInitialForm" style="display: block;">
                <input type="tel" class="login-input" id="repPhone" placeholder="Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ">
                <button class="login-btn" onclick="checkRepRegistration()">Ø§Ù„ØªØ§Ù„ÙŠ</button>
            </div>

            <!-- Rep Complete Registration -->
            <div id="repCompleteForm" style="display: none;">
                <div style="background: #f5f5f5; padding: 16px; border-radius: 12px; margin-bottom: 16px; text-align: right;">
                    <div style="font-size: 14px; color: #666; margin-bottom: 8px;">Ø§Ù„Ù‡Ø§ØªÙ: <span id="regPhoneDisplay"></span></div>
                    <input type="text" class="login-input" id="repName" placeholder="Ø§Ù„Ø§Ø³Ù… Ø§Ù„ÙƒØ§Ù…Ù„" style="margin-bottom: 12px;">
                    <input type="password" class="login-input" id="repPassword" placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±" style="margin-bottom: 12px;">
                    
                    <div style="font-size: 14px; color: #666; margin: 12px 0 8px;">Ø§Ù„Ù…Ù†Ø·Ù‚Ø©/Ø§Ù„Ù…Ø­Ø§ÙØ¸Ø©</div>
                    <select class="login-input" id="repRegion" style="margin-bottom: 12px;">
                        <option value="">Ø§Ø®ØªØ± Ø§Ù„Ù…Ù†Ø·Ù‚Ø©</option>
                        <option value="Ø§Ù„Ù‚Ù„ÙŠÙˆØ¨ÙŠØ©">Ø§Ù„Ù‚Ù„ÙŠÙˆØ¨ÙŠØ©</option>
                        <option value="Ø§Ù„Ø´Ø±Ù‚ÙŠØ©">Ø§Ù„Ø´Ø±Ù‚ÙŠØ©</option>
                        <option value="Ø§Ù„ØºØ±Ø¨ÙŠØ©">Ø§Ù„ØºØ±Ø¨ÙŠØ©</option>
                        <option value="Ø§Ù„Ø¯Ù‚Ù‡Ù„ÙŠØ©">Ø§Ù„Ø¯Ù‚Ù‡Ù„ÙŠØ©</option>
                        <option value="ÙƒÙØ± Ø§Ù„Ø´ÙŠØ®">ÙƒÙØ± Ø§Ù„Ø´ÙŠØ®</option>
                        <option value="Ø§Ù„Ø¨Ø­ÙŠØ±Ø©">Ø§Ù„Ø¨Ø­ÙŠØ±Ø©</option>
                        <option value="Ø§Ù„Ù…Ù†ÙˆÙÙŠØ©">Ø§Ù„Ù…Ù†ÙˆÙÙŠØ©</option>
                        <option value="Ø§Ù„Ø¬ÙŠØ²Ø©">Ø§Ù„Ø¬ÙŠØ²Ø©</option>
                        <option value="Ø§Ù„ÙÙŠÙˆÙ…">Ø§Ù„ÙÙŠÙˆÙ…</option>
                        <option value="Ø¨Ù†ÙŠ Ø³ÙˆÙŠÙ">Ø¨Ù†ÙŠ Ø³ÙˆÙŠÙ</option>
                    </select>

                    <div style="font-size: 14px; color: #666; margin: 12px 0 8px;">Ø§Ù„Ù…Ø±ÙƒØ²</div>
                    <input type="text" class="login-input" id="repCenter" placeholder="Ø§Ù„Ù…Ø±ÙƒØ²/Ø§Ù„Ù…Ø¯ÙŠÙ†Ø©" style="margin-bottom: 12px;">
                    
                    <div style="font-size: 14px; color: #666; margin: 12px 0 8px;">Ø§Ù„Ù‚Ø±ÙŠØ©/Ø§Ù„Ù…Ù†Ø·Ù‚Ø©</div>
                    <input type="text" class="login-input" id="repVillage" placeholder="Ø§Ù„Ù‚Ø±ÙŠØ©/Ø§Ù„Ø­ÙŠ" style="margin-bottom: 12px;">
                </div>
                <button class="login-btn" onclick="completeRepRegistration()">ØªØ³Ø¬ÙŠÙ„</button>
            </div>

            <!-- Rep Login Form (Existing) -->
            <div id="repLoginForm" style="display: none;">
                <input type="tel" class="login-input" id="repLoginPhone" placeholder="Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ">
                <input type="password" class="login-input" id="repLoginPassword" placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±">
                <button class="login-btn" onclick="handleLogin('rep')">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</button>
            </div>

            <div id="managerLoginForm" style="display: none;">
                <input type="email" class="login-input" id="managerEmail" placeholder="Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ">
                <input type="password" class="login-input" id="managerPassword" placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±">
                <button class="login-btn btn-purple" onclick="handleLogin('manager')">Ø¯Ø®ÙˆÙ„ Ø§Ù„Ù…Ø¯ÙŠØ±</button>
            </div>

            <div id="adminLoginForm" style="display: none;">
                <input type="password" class="login-input" id="adminPassword" placeholder="ÙƒÙ„Ù…Ø© Ù…Ø±ÙˆØ± Ø§Ù„Ø£Ø¯Ù…Ù†">
                <button class="login-btn btn-danger" onclick="handleLogin('admin')">Ø¯Ø®ÙˆÙ„ Ø§Ù„Ø£Ø¯Ù…Ù†</button>
            </div>

            <div id="loginError" style="color: var(--danger); margin-top: 16px; display: none;"></div>
        </div>
    </div>

    <!-- App Loader -->
    <div class="app-loader hidden" id="appLoader">
        <div class="loader-content">
            <div class="loader-logo">ğŸŒ¾</div>
            <div style="font-size: 32px; font-weight: bold; color: white; margin-bottom: 8px;">KemetChem Pro</div>
            <div style="font-size: 16px; color: rgba(255,255,255,0.9);">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</div>
        </div>
    </div>

    <!-- Connection Status -->
    <div class="connection-status" id="connectionStatus"></div>

    <!-- Geofence Alert -->
    <div class="geofence-alert" id="geofenceAlert">
        <span>âš ï¸</span>
        <div>
            <div style="font-weight: bold;">Ø®Ø§Ø±Ø¬ Ù†Ø·Ø§Ù‚ Ø§Ù„Ø¹Ù…ÙŠÙ„!</div>
            <div style="font-size: 13px;">ÙŠØ¬Ø¨ Ø£Ù† ØªÙƒÙˆÙ† Ø¶Ù…Ù† 100 Ù…ØªØ± Ù„ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø²ÙŠØ§Ø±Ø©</div>
        </div>
    </div>

    <!-- Header -->
    <header class="app-header" id="appHeader" style="display: none;">
        <button class="menu-btn" onclick="toggleNav()">â˜°</button>
        <div class="header-title">
            <h1 id="companyName">KemetChem</h1>
            <p id="userRoleDisplay">Ù†Ø¸Ø§Ù… Ø§Ù„Ù…Ù†Ø¯ÙˆØ¨ÙŠÙ†</p>
        </div>
        <button class="menu-btn" onclick="showSection('home')">ğŸ </button>
    </header>

    <!-- Navigation -->
    <div class="nav-overlay" id="navOverlay" onclick="closeNav()"></div>
    <nav class="side-nav" id="sideNav">
        <div class="nav-header">
            <div class="nav-logo">ğŸŒ¾</div>
            <div style="font-size: 22px; font-weight: bold;">KemetChem Pro</div>
            <div style="font-size: 14px; opacity: 0.9;" id="navCompanyName">Ø´Ø±ÙƒØªÙƒ</div>
            
            <div class="nav-user-info" style="margin-top: 16px; padding: 12px; background: rgba(255,255,255,0.15); border-radius: var(--radius-md);">
                <div style="font-size: 12px; opacity: 0.8;" id="navUserRole">Ù…Ù†Ø¯ÙˆØ¨</div>
                <div style="font-size: 16px; font-weight: 600;" id="navUserName">Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…</div>
                <div style="font-size: 12px; opacity: 0.8; margin-top: 4px;" id="navUserRegion">Ø§Ù„Ù…Ù†Ø·Ù‚Ø©</div>
            </div>
            
            <div class="nav-stats">
                <div class="nav-stat">
                    <div class="nav-stat-value" id="navTotalCustomers">0</div>
                    <div class="nav-stat-label">Ø¹Ù…ÙŠÙ„</div>
                </div>
                <div class="nav-stat">
                    <div class="nav-stat-value" id="navTodaySales">0</div>
                    <div class="nav-stat-label">Ù…Ø¨ÙŠØ¹Ø§Øª Ø§Ù„ÙŠÙˆÙ…</div>
                </div>
            </div>
        </div>
        
        <div class="nav-items">
            <div class="nav-item" onclick="navigateTo('home')">
                <div class="nav-item-icon">ğŸ“Š</div>
                <div>
                    <div style="font-weight: 600;">Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</div>
                    <div style="font-size: 12px; color: #999;">Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…</div>
                </div>
            </div>
            <div class="nav-item" onclick="navigateTo('customers')">
                <div class="nav-item-icon">ğŸ‘¥</div>
                <div>
                    <div style="font-weight: 600;">Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡</div>
                    <div style="font-size: 12px; color: #999;">Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡</div>
                </div>
            </div>
            <div class="nav-item" onclick="navigateTo('routePlanner')">
                <div class="nav-item-icon" style="background: linear-gradient(135deg, var(--info) 0%, #2980b9 100%);">ğŸ—ºï¸</div>
                <div>
                    <div style="font-weight: 600;">Ø®Ø· Ø§Ù„Ø³ÙŠØ±</div>
                    <div style="font-size: 12px; color: #999;">Planner Ø°ÙƒÙŠ</div>
                </div>
            </div>
            <div class="nav-item" onclick="navigateTo('invoices')">
                <div class="nav-item-icon">ğŸ§¾</div>
                <div>
                    <div style="font-weight: 600;">Ø§Ù„ÙÙˆØ§ØªÙŠØ±</div>
                    <div style="font-size: 12px; color: #999;">Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª</div>
                </div>
            </div>
            <div class="nav-item" onclick="navigateTo('payments')">
                <div class="nav-item-icon">ğŸ’µ</div>
                <div>
                    <div style="font-weight: 600;">Ø§Ù„ØªØ­ØµÙŠÙ„</div>
                    <div style="font-size: 12px; color: #999;">Ø§Ù„Ù…Ø¯ÙÙˆØ¹Ø§Øª</div>
                </div>
            </div>
            <div class="nav-item" onclick="navigateTo('visits')">
                <div class="nav-item-icon">ğŸ“</div>
                <div>
                    <div style="font-weight: 600;">Ø§Ù„Ø²ÙŠØ§Ø±Ø§Øª</div>
                    <div style="font-size: 12px; color: #999;">ØªØªØ¨Ø¹ Ø§Ù„Ø²ÙŠØ§Ø±Ø§Øª</div>
                </div>
            </div>
            
            <div style="height: 1px; background: #e0e0e0; margin: 12px 24px;"></div>
            
            <div class="nav-item" onclick="navigateTo('kpi')">
                <div class="nav-item-icon" style="background: linear-gradient(135deg, var(--purple) 0%, #9c27b0 100%);">ğŸ¯</div>
                <div>
                    <div style="font-weight: 600;">KPIs & Ø§Ù„ØªØ§Ø±Ø¬Øª</div>
                    <div style="font-size: 12px; color: #999;">Ø£Ø¯Ø§Ø¦ÙŠ</div>
                </div>
            </div>
            <div class="nav-item" onclick="navigateTo('aging')">
                <div class="nav-item-icon" style="background: linear-gradient(135deg, var(--danger) 0%, #c0392b 100%);">â°</div>
                <div>
                    <div style="font-weight: 600;">Ø£Ø¹Ù…Ø§Ø± Ø§Ù„Ø¯ÙŠÙˆÙ†</div>
                    <div style="font-size: 12px; color: #999;">Aging Report</div>
                </div>
            </div>
            <div class="nav-item" onclick="navigateTo('reports')">
                <div class="nav-item-icon">ğŸ“ˆ</div>
                <div>
                    <div style="font-weight: 600;">Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ±</div>
                    <div style="font-size: 12px; color: #999;">ØªØ­Ù„ÙŠÙ„Ø§Øª</div>
                </div>
            </div>
            
            <div class="manager-only" style="display: none;">
                <div style="height: 1px; background: #e0e0e0; margin: 12px 24px;"></div>
                <div style="padding: 8px 24px; font-size: 12px; color: #999; font-weight: 600;">ØµÙ„Ø§Ø­ÙŠØ§Øª Ø§Ù„Ù…Ø¯ÙŠØ±</div>
                <div class="nav-item" onclick="navigateTo('suggestedCustomers')">
                    <div class="nav-item-icon" style="background: linear-gradient(135deg, var(--secondary) 0%, #e67e22 100%);">ğŸ’¡</div>
                    <div>
                        <div style="font-weight: 600;">Ø¹Ù…Ù„Ø§Ø¡ Ù…Ù‚ØªØ±Ø­ÙŠÙ†</div>
                        <div style="font-size: 12px; color: #999;">Ø¥Ø¶Ø§ÙØ© Ø¹Ù…Ù„Ø§Ø¡ Ø¬Ø¯Ø¯</div>
                    </div>
                </div>
                <div class="nav-item" onclick="navigateTo('teamManagement')">
                    <div class="nav-item-icon" style="background: linear-gradient(135deg, var(--purple) 0%, #9c27b0 100%);">ğŸ‘¥</div>
                    <div>
                        <div style="font-weight: 600;">ÙØ±ÙŠÙ‚ Ø§Ù„Ù…Ù†Ø¯ÙˆØ¨ÙŠÙ†</div>
                        <div style="font-size: 12px; color: #999;">Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„ÙØ±ÙŠÙ‚</div>
                    </div>
                </div>
                <div class="nav-item" onclick="navigateTo('targets')">
                    <div class="nav-item-icon" style="background: linear-gradient(135deg, var(--secondary) 0%, #e67e22 100%);">ğŸ¯</div>
                    <div>
                        <div style="font-weight: 600;">ØªÙˆØ²ÙŠØ¹ Ø§Ù„ØªØ§Ø±Ø¬Øª</div>
                        <div style="font-size: 12px; color: #999;">Ø§Ù„Ø£Ù‡Ø¯Ø§Ù Ø§Ù„Ø´Ù‡Ø±ÙŠØ©</div>
                    </div>
                </div>
            </div>
            
            <div style="height: 1px; background: #e0e0e0; margin: 12px 24px;"></div>
            <div class="nav-item" onclick="logout()">
                <div class="nav-item-icon" style="background: #666;">ğŸšª</div>
                <div>
                    <div style="font-weight: 600;">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬</div>
                </div>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <main class="main-content" id="mainContent" style="display: none;">
        
        <!-- Home Section -->
        <section class="section active" id="home">
            <!-- KPI Cards -->
            <div class="kpi-grid">
                <div class="kpi-card">
                    <div class="kpi-label">Ù…Ø¨ÙŠØ¹Ø§Øª Ø§Ù„ÙŠÙˆÙ…</div>
                    <div class="kpi-value" id="kpiTodaySales">0</div>
                    <div class="kpi-change positive" id="kpiSalesChange">â†‘ 12%</div>
                </div>
                <div class="kpi-card">
                    <div class="kpi-label">Ø§Ù„Ø²ÙŠØ§Ø±Ø§Øª</div>
                    <div class="kpi-value" id="kpiTodayVisits">0</div>
                    <div class="kpi-change positive" id="kpiVisitsChange">â†‘ 5</div>
                </div>
                <div class="kpi-card">
                    <div class="kpi-label">Ù…Ø¹Ø¯Ù„ Ø§Ù„ØªØ­ÙˆÙŠÙ„</div>
                    <div class="kpi-value" id="kpiConversion">0%</div>
                    <div class="kpi-change" id="kpiConversionChange">Ø§Ù„Ù‡Ø¯Ù: 30%</div>
                </div>
                <div class="kpi-card">
                    <div class="kpi-label">Ø§Ù„ØªØ§Ø±Ø¬Øª Ø§Ù„Ø´Ù‡Ø±ÙŠ</div>
                    <div class="kpi-value" id="kpiTargetProgress">0%</div>
                    <div class="progress-bar" style="margin-top: 8px;">
                        <div class="progress-fill" id="kpiTargetBar" style="width: 0%"></div>
                    </div>
                </div>
            </div>

            <!-- Quick Actions -->
            <div class="card">
                <div class="card-header">
                    <div class="card-title">
                        <div class="card-icon">âš¡</div>
                        Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª Ø³Ø±ÙŠØ¹Ø©
                    </div>
                </div>
                <button class="btn btn-primary" onclick="openInvoiceModal()">
                    <span>ğŸ§¾</span>
                    <span>ÙØ§ØªÙˆØ±Ø© Ø¬Ø¯ÙŠØ¯Ø©</span>
                </button>
                <div class="btn-row">
                    <button class="btn btn-success" onclick="openPaymentModal()">
                        <span>ğŸ’µ</span>
                        <span>ØªØ­ØµÙŠÙ„</span>
                    </button>
                    <button class="btn btn-warning" onclick="openVisitModal()">
                        <span>ğŸ“</span>
                        <span>Ø²ÙŠØ§Ø±Ø© + GPS</span>
                    </button>
                </div>
            </div>

            <!-- AI Suggestions -->
            <div class="card" id="aiSuggestions" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white;">
                <div class="card-header" style="border-bottom: 1px solid rgba(255,255,255,0.2);">
                    <div class="card-title" style="color: white;">
                        <div class="card-icon" style="background: rgba(255,255,255,0.2);">ğŸ¤–</div>
                        Ø§Ù‚ØªØ±Ø§Ø­Ø§Øª Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ
                    </div>
                </div>
                <div id="aiSuggestionsList" style="font-size: 14px; line-height: 2;">
                    <div style="padding: 12px; background: rgba(255,255,255,0.1); border-radius: 12px; margin-bottom: 8px;">
                        ğŸ’¡ <strong>Ø§Ù‚ØªØ±Ø§Ø­:</strong> Ø²ÙŠØ§Ø±Ø© "Ø£Ø­Ù…Ø¯ Ù…Ø­Ù…Ø¯" - Ù„Ù… ÙŠÙØ²Ø± Ù…Ù† 20 ÙŠÙˆÙ… ÙˆØ¹Ù„ÙŠÙ‡ 15,000 Ø¬
                    </div>
                    <div style="padding: 12px; background: rgba(255,255,255,0.1); border-radius: 12px;">
                        ğŸ¯ <strong>Ø£Ù‚Ø±Ø¨ Ø¹Ù…ÙŠÙ„:</strong> "Ù…Ø­Ù…Ø¯ Ø¹Ù„ÙŠ" Ø¹Ù„Ù‰ Ø¨Ø¹Ø¯ 2.3 ÙƒÙ… Ù…Ù† Ù…ÙˆÙ‚Ø¹Ùƒ Ø§Ù„Ø­Ø§Ù„ÙŠ
                    </div>
                </div>
            </div>

            <!-- Suggested Customers Alert -->
            <div class="suggested-customers" id="suggestedAlert" style="display: none;">
                <span class="suggested-badge">ğŸ’¡ Ø¹Ù…Ù„Ø§Ø¡ Ù…Ù‚ØªØ±Ø­ÙŠÙ† Ù…ØªØ§Ø­ÙŠÙ†</span>
                <div style="font-size: 14px; margin-bottom: 12px;">
                    Ù‡Ù†Ø§Ùƒ <strong id="suggestedCount">0</strong> Ø¹Ù…Ù„Ø§Ø¡ Ù…Ù‚ØªØ±Ø­ÙŠÙ† ÙÙŠ Ù…Ù†Ø·Ù‚ØªÙƒ Ù…ØªØ§Ø­ÙŠÙ† Ù„Ù„Ø´Ø±Ø§Ø¡
                </div>
                <button class="btn btn-warning" onclick="navigateTo('suggestedCustomers')">
                    <span>ğŸ‘ï¸</span>
                    <span>Ø¹Ø±Ø¶ Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡ Ø§Ù„Ù…Ù‚ØªØ±Ø­ÙŠÙ†</span>
                </button>
            </div>
        </section>

        <!-- Customers Section -->
        <section class="section" id="customers">
            <div class="card">
                <div class="card-header">
                    <div class="card-title">
                        <div class="card-icon">ğŸ‘¥</div>
                        Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡
                    </div>
                </div>
                <div class="btn-row">
                    <button class="btn btn-success" onclick="openCustomerModal()">
                        <span>â•</span>
                        <span>Ø¹Ù…ÙŠÙ„ Ø¬Ø¯ÙŠØ¯</span>
                    </button>
                    <button class="btn btn-info" onclick="openExcelImportModal()">
                        <span>ğŸ“¥</span>
                        <span>Ø§Ø³ØªÙŠØ±Ø§Ø¯</span>
                    </button>
                </div>
            </div>

            <div class="search-container">
                <div class="search-box">
                    <span class="search-icon">ğŸ”</span>
                    <input type="text" class="search-input" id="customerSearch" placeholder="Ø§Ø¨Ø­Ø« Ø¨Ø§Ù„Ø§Ø³Ù…ØŒ Ø§Ù„Ù‡Ø§ØªÙØŒ Ø§Ù„Ø¹Ù†ÙˆØ§Ù†..." oninput="handleSearch(this.value)">
                </div>
            </div>

            <div class="governorate-tabs" id="customersGovTabs" style="display: flex; gap: 10px; overflow-x: auto; padding: 12px 0; margin-bottom: 20px;"></div>
            <div id="customersList" class="list-container"></div>
        </section>

        <!-- Route Planner Section -->
        <section class="section" id="routePlanner">
            <div class="card">
                <div class="card-header">
                    <div class="card-title">
                        <div class="card-icon" style="background: linear-gradient(135deg, var(--info) 0%, #2980b9 100%);">ğŸ—ºï¸</div>
                        Planner Ø°ÙƒÙŠ - Ø®Ø· Ø§Ù„Ø³ÙŠØ± Ø§Ù„ÙŠÙˆÙ…ÙŠ
                    </div>
                </div>
                <button class="btn btn-primary" onclick="generateOptimalRoute()">
                    <span>ğŸ§®</span>
                    <span>Ø­Ø³Ø§Ø¨ Ø£ÙØ¶Ù„ Ø®Ø· Ø³ÙŠØ±</span>
                </button>
            </div>

            <div id="routeStats" style="display: none; margin-bottom: 20px;">
                <div class="stats-grid">
                    <div class="stat-card visits">
                        <div class="stat-icon">ğŸ“</div>
                        <div class="stat-label">Ø¹Ø¯Ø¯ Ø§Ù„Ø²ÙŠØ§Ø±Ø§Øª</div>
                        <div class="stat-value" id="routeVisitsCount">0</div>
                    </div>
                    <div class="stat-card payments">
                        <div class="stat-icon">ğŸ›£ï¸</div>
                        <div class="stat-label">Ø§Ù„Ù…Ø³Ø§ÙØ© Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠØ©</div>
                        <div class="stat-value" id="routeTotalDistance">0 ÙƒÙ…</div>
                    </div>
                </div>
            </div>

            <div id="routeList" class="list-container"></div>
        </section>

        <!-- Aging Report Section -->
        <section class="section" id="aging">
            <div class="card">
                <div class="card-header">
                    <div class="card-title">
                        <div class="card-icon" style="background: linear-gradient(135deg, var(--danger) 0%, #c0392b 100%);">â°</div>
                        ØªÙ‚Ø±ÙŠØ± Ø£Ø¹Ù…Ø§Ø± Ø§Ù„Ø¯ÙŠÙˆÙ† (Aging)
                    </div>
                </div>
                
                <div class="stats-grid" style="margin-bottom: 20px;">
                    <div class="stat-card sales">
                        <div class="stat-icon" style="background: rgba(39, 174, 96, 0.1); color: var(--success);">ğŸ“…</div>
                        <div class="stat-label">0-30 ÙŠÙˆÙ…</div>
                        <div class="stat-value" id="aging30">0</div>
                    </div>
                    <div class="stat-card visits">
                        <div class="stat-icon" style="background: rgba(243, 156, 18, 0.1); color: var(--secondary);">ğŸ“…</div>
                        <div class="stat-label">31-60 ÙŠÙˆÙ…</div>
                        <div class="stat-value" id="aging60">0</div>
                    </div>
                    <div class="stat-card credit">
                        <div class="stat-icon" style="background: rgba(231, 76, 60, 0.1); color: var(--danger);">ğŸ“…</div>
                        <div class="stat-label">61-90 ÙŠÙˆÙ…</div>
                        <div class="stat-value" id="aging90">0</div>
                    </div>
                    <div class="stat-card payments">
                        <div class="stat-icon" style="background: rgba(106, 27, 154, 0.1); color: var(--purple);">ğŸ“…</div>
                        <div class="stat-label">+90 ÙŠÙˆÙ…</div>
                        <div class="stat-value" id="agingPlus">0</div>
                    </div>
                </div>

                <table class="aging-table">
                    <thead>
                        <tr>
                            <th>Ø§Ù„Ø¹Ù…ÙŠÙ„</th>
                            <th>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø¯ÙŠÙ†</th>
                            <th>0-30 ÙŠÙˆÙ…</th>
                            <th>31-60 ÙŠÙˆÙ…</th>
                            <th>61-90 ÙŠÙˆÙ…</th>
                            <th>+90 ÙŠÙˆÙ…</th>
                            <th>Ø§Ù„Ø­Ø§Ù„Ø©</th>
                        </tr>
                    </thead>
                    <tbody id="agingTableBody"></tbody>
                </table>
            </div>
        </section>

        <!-- KPI Section -->
        <section class="section" id="kpi">
            <div class="card">
                <div class="card-header">
                    <div class="card-title">
                        <div class="card-icon" style="background: linear-gradient(135deg, var(--purple) 0%, #9c27b0 100%);">ğŸ¯</div>
                        Ù…Ø¤Ø´Ø±Ø§Øª Ø§Ù„Ø£Ø¯Ø§Ø¡ (KPIs)
                    </div>
                </div>
                
                <div style="background: linear-gradient(135deg, #f5f5f5 0%, #e0e0e0 100%); padding: 20px; border-radius: 16px; margin-bottom: 20px;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
                        <span style="font-weight: 600;">Ø§Ù„ØªØ§Ø±Ø¬Øª Ø§Ù„Ø´Ù‡Ø±ÙŠ:</span>
                        <span style="font-size: 24px; font-weight: bold; color: var(--primary);" id="monthlyTarget">100,000 Ø¬.Ù…</span>
                    </div>
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
                        <span style="font-weight: 600;">Ø§Ù„ØªØ­Ù‚ÙŠÙ‚ Ø­ØªÙ‰ Ø§Ù„Ø¢Ù†:</span>
                        <span style="font-size: 24px; font-weight: bold; color: var(--success);" id="achievedTarget">0 Ø¬.Ù…</span>
                    </div>
                    <div class="progress-bar" style="height: 12px;">
                        <div class="progress-fill" id="targetProgressBar" style="width: 0%;"></div>
                    </div>
                    <div style="text-align: center; margin-top: 8px; font-size: 14px; color: #666;" id="targetPercentage">0%</div>
                </div>

                <div class="kpi-grid">
                    <div class="kpi-card">
                        <div class="kpi-label">Ù…ØªÙˆØ³Ø· Ù‚ÙŠÙ…Ø© Ø§Ù„ÙØ§ØªÙˆØ±Ø©</div>
                        <div class="kpi-value" id="kpiAvgInvoice">0</div>
                    </div>
                    <div class="kpi-card">
                        <div class="kpi-label">Ø¹Ø¯Ø¯ Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡ Ø§Ù„Ù†Ø´Ø·ÙŠÙ†</div>
                        <div class="kpi-value" id="kpiActiveCustomers">0</div>
                    </div>
                    <div class="kpi-card">
                        <div class="kpi-label">Ù…Ø¹Ø¯Ù„ Ø§Ù„Ø²ÙŠØ§Ø±Ø§Øª/Ø§Ù„ÙŠÙˆÙ…</div>
                        <div class="kpi-value" id="kpiVisitsPerDay">0</div>
                    </div>
                    <div class="kpi-card">
                        <div class="kpi-label">Ù†Ø³Ø¨Ø© Ø§Ù„ØªØ­ØµÙŠÙ„</div>
                        <div class="kpi-value" id="kpiCollectionRate">0%</div>
                    </div>
                </div>
            </div>
        </section>

        <!-- Suggested Customers Section (Manager Only) -->
        <section class="section" id="suggestedCustomers">
            <div class="card">
                <div class="card-header">
                    <div class="card-title">
                        <div class="card-icon" style="background: linear-gradient(135deg, var(--secondary) 0%, #e67e22 100%);">ğŸ’¡</div>
                        Ø¹Ù…Ù„Ø§Ø¡ Ù…Ù‚ØªØ±Ø­ÙŠÙ† Ù„Ù„Ù…Ù†Ø·Ù‚Ø©
                    </div>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Ø§Ø®ØªØ± Ø§Ù„Ù…Ù†Ø·Ù‚Ø©</label>
                    <select class="form-control" id="suggestedRegionFilter" onchange="loadSuggestedCustomers()">
                        <option value="">Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ù†Ø§Ø·Ù‚</option>
                    </select>
                </div>

                <div id="suggestedCustomersList" class="list-container"></div>
            </div>
        </section>

        <!-- Invoices Section -->
        <section class="section" id="invoices">
            <div class="card">
                <div class="card-header">
                    <div class="card-title">
                        <div class="card-icon">ğŸ§¾</div>
                        Ø§Ù„ÙÙˆØ§ØªÙŠØ±
                    </div>
                </div>
                <button class="btn btn-primary" onclick="openInvoiceModal()">
                    <span>â•</span>
                    <span>ÙØ§ØªÙˆØ±Ø© Ø¬Ø¯ÙŠØ¯Ø©</span>
                </button>
            </div>
            <div id="invoicesList" class="list-container"></div>
        </section>

        <!-- Payments Section -->
        <section class="section" id="payments">
            <div class="card">
                <div class="card-header">
                    <div class="card-title">
                        <div class="card-icon">ğŸ’µ</div>
                        Ø§Ù„ØªØ­ØµÙŠÙ„
                    </div>
                </div>
                <button class="btn btn-success" onclick="openPaymentModal()">
                    <span>â•</span>
                    <span>ØªØ­ØµÙŠÙ„ Ø¬Ø¯ÙŠØ¯</span>
                </button>
            </div>
            <div id="paymentsList" class="list-container"></div>
        </section>

        <!-- Visits Section -->
        <section class="section" id="visits">
            <div class="card">
                <div class="card-header">
                    <div class="card-title">
                        <div class="card-icon">ğŸ“</div>
                        Ø§Ù„Ø²ÙŠØ§Ø±Ø§Øª
                    </div>
                </div>
                <button class="btn btn-warning" onclick="openVisitModal()">
                    <span>â•</span>
                    <span>Ø²ÙŠØ§Ø±Ø© Ø¬Ø¯ÙŠØ¯Ø©</span>
                </button>
            </div>
            <div id="visitsList" class="list-container"></div>
        </section>
    </main>

    <!-- Modals -->
    <!-- Visit Modal with Geofencing -->
    <div class="modal" id="visitModal">
        <div class="modal-content">
            <div class="modal-header" style="background: linear-gradient(135deg, var(--secondary) 0%, #e67e22 100%);">
                <div class="modal-title">ğŸ“ Ø²ÙŠØ§Ø±Ø© Ø¬Ø¯ÙŠØ¯Ø© + GPS</div>
                <button class="modal-close" onclick="closeModal('visitModal')">âœ•</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label">Ø§Ù„Ø¹Ù…ÙŠÙ„</label>
                    <div class="search-box">
                        <span class="search-icon">ğŸ”</span>
                        <input type="text" class="form-control" id="visitCustomerSearch" placeholder="Ø§Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„Ø¹Ù…ÙŠÙ„..." oninput="searchCustomers(this.value, 'visit')">
                    </div>
                    <input type="hidden" id="visitCustomer">
                    <input type="hidden" id="visitCustomerLat">
                    <input type="hidden" id="visitCustomerLng">
                </div>

                <div class="gps-section">
                    <div style="font-size: 18px; font-weight: bold; margin-bottom: 16px; display: flex; align-items: center; gap: 10px;">
                        ğŸ“ ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù…ÙˆÙ‚Ø¹ (Geofencing)
                    </div>

                    <button type="button" class="gps-btn-main" id="gpsBtn" onclick="captureLocationWithValidation()">
                        <span id="gpsBtnIcon">ğŸ“¡</span>
                        <span id="gpsBtnText">Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ù…ÙˆÙ‚Ø¹</span>
                    </button>

                    <div class="gps-status" id="gpsStatus">
                        <span id="gpsStatusIcon">â³</span>
                        <div style="flex: 1;">
                            <div id="gpsStatusText">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù‚Ù‚...</div>
                            <div style="font-size: 12px; margin-top: 4px; opacity: 0.9;" id="gpsAccuracy"></div>
                        </div>
                    </div>

                    <div id="geofenceResult" style="margin-top: 12px; padding: 12px; border-radius: 12px; display: none; text-align: center; font-weight: 600;"></div>

                    <div id="staticMap"></div>
                </div>

                <div class="form-group">
                    <label class="form-label">Ù…Ù„Ø§Ø­Ø¸Ø§Øª</label>
                    <textarea class="form-control" id="visitNotes" rows="3"></textarea>
                </div>

                <button class="btn btn-success" id="saveVisitBtn" onclick="saveVisit()" disabled>
                    <span>ğŸ’¾</span>
                    <span>Ø­ÙØ¸ Ø§Ù„Ø²ÙŠØ§Ø±Ø©</span>
                </button>
            </div>
        </div>
    </div>

    <!-- Customer Modal with Rating -->
    <div class="modal" id="customerModal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">â• Ø¹Ù…ÙŠÙ„ Ø¬Ø¯ÙŠØ¯</div>
                <button class="modal-close" onclick="closeModal('customerModal')">âœ•</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label">Ø§Ø³Ù… Ø§Ù„Ø¹Ù…ÙŠÙ„</label>
                    <input type="text" class="form-control" id="customerName" placeholder="Ø§Ø³Ù… Ø§Ù„Ø¹Ù…ÙŠÙ„ Ø§Ù„ÙƒØ§Ù…Ù„">
                </div>
                
                <div class="form-group">
                    <label class="form-label">Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ</label>
                    <input type="tel" class="form-control" id="customerPhone" placeholder="01xxxxxxxxx">
                </div>

                <div class="form-group">
                    <label class="form-label">Ø§Ù„Ù…Ø­Ø§ÙØ¸Ø©</label>
                    <select class="form-control" id="customerGovernorate">
                        <option value="">Ø§Ø®ØªØ± Ø§Ù„Ù…Ø­Ø§ÙØ¸Ø©</option>
                        <option value="Ø§Ù„Ù‚Ù„ÙŠÙˆØ¨ÙŠØ©">Ø§Ù„Ù‚Ù„ÙŠÙˆØ¨ÙŠØ©</option>
                        <option value="Ø§Ù„Ø´Ø±Ù‚ÙŠØ©">Ø§Ù„Ø´Ø±Ù‚ÙŠØ©</option>
                        <option value="Ø§Ù„ØºØ±Ø¨ÙŠØ©">Ø§Ù„ØºØ±Ø¨ÙŠØ©</option>
                        <option value="Ø§Ù„Ø¯Ù‚Ù‡Ù„ÙŠØ©">Ø§Ù„Ø¯Ù‚Ù‡Ù„ÙŠØ©</option>
                        <option value="ÙƒÙØ± Ø§Ù„Ø´ÙŠØ®">ÙƒÙØ± Ø§Ù„Ø´ÙŠØ®</option>
                        <option value="Ø§Ù„Ø¨Ø­ÙŠØ±Ø©">Ø§Ù„Ø¨Ø­ÙŠØ±Ø©</option>
                        <option value="Ø§Ù„Ù…Ù†ÙˆÙÙŠØ©">Ø§Ù„Ù…Ù†ÙˆÙÙŠØ©</option>
                        <option value="Ø§Ù„Ø¬ÙŠØ²Ø©">Ø§Ù„Ø¬ÙŠØ²Ø©</option>
                        <option value="Ø§Ù„ÙÙŠÙˆÙ…">Ø§Ù„ÙÙŠÙˆÙ…</option>
                        <option value="Ø¨Ù†ÙŠ Ø³ÙˆÙŠÙ">Ø¨Ù†ÙŠ Ø³ÙˆÙŠÙ</option>
                    </select>
                </div>

                <div class="form-group">
                    <label class="form-label">Ø§Ù„Ù…Ø±ÙƒØ²</label>
                    <input type="text" class="form-control" id="customerCenter" placeholder="Ø§Ù„Ù…Ø±ÙƒØ²/Ø§Ù„Ù…Ø¯ÙŠÙ†Ø©">
                </div>

                <div class="form-group">
                    <label class="form-label">Ø§Ù„Ù‚Ø±ÙŠØ©/Ø§Ù„Ù…Ù†Ø·Ù‚Ø©</label>
                    <input type="text" class="form-control" id="customerVillage" placeholder="Ø§Ù„Ù‚Ø±ÙŠØ©/Ø§Ù„Ø­ÙŠ">
                </div>

                <div class="form-group">
                    <label class="form-label">Ø§Ù„Ø¹Ù†ÙˆØ§Ù† Ø§Ù„ØªÙØµÙŠÙ„ÙŠ</label>
                    <input type="text" class="form-control" id="customerAddress" placeholder="Ø§Ù„Ø¹Ù†ÙˆØ§Ù† Ø¨Ø§Ù„ØªÙØµÙŠÙ„">
                </div>

                <div class="form-group">
                    <label class="form-label">Ù†ÙˆØ¹ Ø§Ù„Ù…Ø­ØµÙˆÙ„</label>
                    <input type="text" class="form-control" id="customerCrop" placeholder="Ù…Ø«Ø§Ù„: Ø¨Ø·Ø§Ø·Ø³ØŒ ÙØ§ÙƒÙ‡Ø©ØŒ Ø®Ø¶Ø§Ø±">
                </div>

                <div class="form-group">
                    <label class="form-label">Ø§Ù„Ù…Ø³Ø§Ø­Ø© (ÙØ¯Ø§Ù†)</label>
                    <input type="number" class="form-control" id="customerArea" placeholder="Ø¹Ø¯Ø¯ Ø§Ù„Ø£ÙØ¯Ù†Ø©">
                </div>

                <!-- Customer Rating Section -->
                <div style="background: #f5f5f5; padding: 20px; border-radius: 12px; margin: 20px 0;">
                    <div style="font-weight: 700; margin-bottom: 16px; text-align: center;">ØªÙ‚ÙŠÙŠÙ… Ø§Ù„Ø¹Ù…ÙŠÙ„</div>
                    
                    <div class="form-group">
                        <label class="form-label">Ø§Ù„ØªÙ‚ÙŠÙŠÙ… Ø§Ù„Ø¹Ø§Ù…</label>
                        <div class="rating-stars" id="customerRating">
                            <span class="star" onclick="setRating(1)">â­</span>
                            <span class="star" onclick="setRating(2)">â­</span>
                            <span class="star" onclick="setRating(3)">â­</span>
                            <span class="star" onclick="setRating(4)">â­</span>
                            <span class="star" onclick="setRating(5)">â­</span>
                        </div>
                        <input type="hidden" id="customerRatingValue" value="0">
                    </div>

                    <div class="form-group">
                        <label class="form-label">Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ø¯ÙØ¹ Ø§Ù„Ù…ØªÙÙ‚ Ø¹Ù„ÙŠÙ‡Ø§</label>
                        <div class="payment-methods">
                            <div class="payment-method" onclick="selectPaymentMethod('cash')">
                                <div class="payment-method-icon">ğŸ’µ</div>
                                <div>ÙƒØ§Ø´</div>
                            </div>
                            <div class="payment-method" onclick="selectPaymentMethod('credit')">
                                <div class="payment-method-icon">ğŸ“…</div>
                                <div>Ø¢Ø¬Ù„</div>
                            </div>
                            <div class="payment-method" onclick="selectPaymentMethod('checks')">
                                <div class="payment-method-icon">ğŸ“„</div>
                                <div>Ø´ÙŠÙƒØ§Øª</div>
                            </div>
                            <div class="payment-method" onclick="selectPaymentMethod('mixed')">
                                <div class="payment-method-icon">ğŸ”„</div>
                                <div>Ù…Ø®ØªÙ„Ø·</div>
                            </div>
                        </div>
                        <input type="hidden" id="customerPaymentMethod" value="">
                    </div>

                    <div class="form-group" id="creditTermsGroup" style="display: none;">
                        <label class="form-label">Ø´Ø±ÙˆØ· Ø§Ù„Ø³Ø¯Ø§Ø¯ (Ø£ÙŠØ§Ù…)</label>
                        <input type="number" class="form-control" id="customerCreditDays" placeholder="Ø¹Ø¯Ø¯ Ø£ÙŠØ§Ù… Ø§Ù„Ø³Ù…Ø§Ø­">
                    </div>

                    <div class="form-group">
                        <label class="form-label">Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø§Ù„ØªØ¹Ø§Ù…Ù„</label>
                        <textarea class="form-control" id="customerNotes" rows="2" placeholder="Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø®Ø§ØµØ© Ø¹Ù† Ø§Ù„Ø¹Ù…ÙŠÙ„..."></textarea>
                    </div>
                </div>

                <button class="btn btn-success" onclick="saveCustomer()">
                    <span>ğŸ’¾</span>
                    <span>Ø­ÙØ¸ Ø§Ù„Ø¹Ù…ÙŠÙ„</span>
                </button>
            </div>
        </div>
    </div>

    <!-- Invoice Modal with Customer Rating -->
    <div class="modal" id="invoiceModal">
        <div class="modal-content">
            <div class="modal-header" style="background: linear-gradient(135deg, var(--primary) 0%, var(--primary-light) 100%);">
                <div class="modal-title">ğŸ§¾ ÙØ§ØªÙˆØ±Ø© Ø¬Ø¯ÙŠØ¯Ø©</div>
                <button class="modal-close" onclick="closeModal('invoiceModal')">âœ•</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label">Ø§Ù„Ø¹Ù…ÙŠÙ„</label>
                    <div class="search-box">
                        <span class="search-icon">ğŸ”</span>
                        <input type="text" class="form-control" id="invoiceCustomerSearch" placeholder="Ø§Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„Ø¹Ù…ÙŠÙ„..." oninput="searchCustomers(this.value, 'invoice')">
                    </div>
                    <input type="hidden" id="invoiceCustomer">
                    
                    <!-- Customer Rating Display -->
                    <div id="customerRatingDisplay" style="display: none; margin-top: 12px; padding: 12px; background: #f5f5f5; border-radius: 8px;">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <div>
                                <div style="font-size: 12px; color: #666;">ØªÙ‚ÙŠÙŠÙ… Ø§Ù„Ø¹Ù…ÙŠÙ„</div>
                                <div id="displayRatingStars" style="font-size: 20px;"></div>
                            </div>
                            <div style="text-align: left;">
                                <div style="font-size: 12px; color: #666;">Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ø¯ÙØ¹</div>
                                <div id="displayPaymentMethod" style="font-weight: 600; color: var(--primary);"></div>
                            </div>
                        </div>
                        <div id="displayCreditDays" style="margin-top: 8px; font-size: 13px; color: #666; display: none;">
                            Ù…Ø¯Ø© Ø§Ù„Ø³Ø¯Ø§Ø¯: <span style="font-weight: 600; color: var(--danger);"></span> ÙŠÙˆÙ…
                        </div>
                    </div>
                </div>

                <div id="invoiceItems">
                    <div class="form-group invoice-item">
                        <label class="form-label">Ø§Ù„Ù…Ù†ØªØ¬</label>
                        <select class="form-control product-select">
                            <option value="">Ø§Ø®ØªØ± Ø§Ù„Ù…Ù†ØªØ¬</option>
                        </select>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-top: 12px;">
                            <input type="number" class="form-control quantity" placeholder="Ø§Ù„ÙƒÙ…ÙŠØ©">
                            <input type="number" class="form-control price" placeholder="Ø§Ù„Ø³Ø¹Ø±">
                        </div>
                    </div>
                </div>

                <button class="btn btn-info" onclick="addInvoiceItem()" style="margin-bottom: 20px;">
                    <span>â•</span>
                    <span>Ø¥Ø¶Ø§ÙØ© Ù…Ù†ØªØ¬</span>
                </button>

                <div class="form-group">
                    <label class="form-label">Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ø¯ÙØ¹</label>
                    <select class="form-control" id="invoicePaymentMethod">
                        <option value="cash">ÙƒØ§Ø´</option>
                        <option value="credit">Ø¢Ø¬Ù„</option>
                        <option value="checks">Ø´ÙŠÙƒØ§Øª</option>
                    </select>
                </div>

                <div class="form-group">
                    <label class="form-label">Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ</label>
                    <input type="number" class="form-control" id="invoiceTotal" readonly>
                </div>

                <button class="btn btn-success" onclick="saveInvoice()">
                    <span>ğŸ’¾</span>
                    <span>Ø­ÙØ¸ Ø§Ù„ÙØ§ØªÙˆØ±Ø©</span>
                </button>
            </div>
        </div>
    </div>

    <!-- Payment Modal -->
    <div class="modal" id="paymentModal">
        <div class="modal-content">
            <div class="modal-header" style="background: linear-gradient(135deg, var(--success) 0%, #2ecc71 100%);">
                <div class="modal-title">ğŸ’µ ØªØ­ØµÙŠÙ„</div>
                <button class="modal-close" onclick="closeModal('paymentModal')">âœ•</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label">Ø§Ù„Ø¹Ù…ÙŠÙ„</label>
                    <div class="search-box">
                        <span class="search-icon">ğŸ”</span>
                        <input type="text" class="form-control" id="paymentCustomerSearch" placeholder="Ø§Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„Ø¹Ù…ÙŠÙ„..." oninput="searchCustomers(this.value, 'payment')">
                    </div>
                    <input type="hidden" id="paymentCustomer">
                    
                    <!-- Customer Debt Display -->
                    <div id="customerDebtDisplay" style="display: none; margin-top: 12px; padding: 12px; background: rgba(231, 76, 60, 0.1); border-radius: 8px; color: var(--danger);">
                        <div style="font-size: 12px;">Ù…Ø¯ÙŠÙˆÙ†ÙŠØ© Ø§Ù„Ø¹Ù…ÙŠÙ„</div>
                        <div id="displayDebtAmount" style="font-size: 24px; font-weight: bold;"></div>
                    </div>
                </div>

                <div class="form-group">
                    <label class="form-label">Ø§Ù„Ù…Ø¨Ù„Øº</label>
                    <input type="number" class="form-control" id="paymentAmount" placeholder="0.00">
                </div>

                <div class="form-group">
                    <label class="form-label">Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„ØªØ­ØµÙŠÙ„</label>
                    <select class="form-control" id="paymentMethod">
                        <option value="cash">Ù†Ù‚Ø¯ÙŠ</option>
                        <option value="check">Ø´ÙŠÙƒ Ø¨Ù†ÙƒÙŠ</option>
                        <option value="transfer">ØªØ­ÙˆÙŠÙ„ Ø¨Ù†ÙƒÙŠ</option>
                    </select>
                </div>

                <div class="form-group" id="checkDetails" style="display: none;">
                    <label class="form-label">Ø±Ù‚Ù… Ø§Ù„Ø´ÙŠÙƒ</label>
                    <input type="text" class="form-control" id="checkNumber" placeholder="Ø±Ù‚Ù… Ø§Ù„Ø´ÙŠÙƒ">
                    <label class="form-label" style="margin-top: 12px;">ØªØ§Ø±ÙŠØ® Ø§Ù„Ø§Ø³ØªØ­Ù‚Ø§Ù‚</label>
                    <input type="date" class="form-control" id="checkDate">
                    <label class="form-label" style="margin-top: 12px;">Ø§Ø³Ù… Ø§Ù„Ø¨Ù†Ùƒ</label>
                    <input type="text" class="form-control" id="bankName" placeholder="Ø§Ø³Ù… Ø§Ù„Ø¨Ù†Ùƒ">
                </div>

                <div class="form-group">
                    <label class="form-label">Ù…Ù„Ø§Ø­Ø¸Ø§Øª</label>
                    <textarea class="form-control" id="paymentNotes" rows="2"></textarea>
                </div>

                <button class="btn btn-success" onclick="savePayment()">
                    <span>ğŸ’¾</span>
                    <span>Ø­ÙØ¸ Ø§Ù„ØªØ­ØµÙŠÙ„</span>
                </button>
            </div>
        </div>
    </div>

    <!-- Toast Container -->
    <div class="toast-container" id="toastContainer"></div>

    <!-- Sync Indicator -->
    <div class="sync-indicator" id="syncIndicator" onclick="manualSync()">
        <span id="syncIcon">ğŸ”„</span>
    </div>

    <script>
        // ==================== CONFIGURATION ====================
        // Supabase Configuration - Replace with your credentials
        const SUPABASE_URL = 'https://your-project.supabase.co';
        const SUPABASE_KEY = 'your-anon-key';
        
        // Initialize Supabase
        let supabase;
        try {
            supabase = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
        } catch(e) {
            console.log('Supabase not configured, using local mode');
        }

        // ==================== GLOBAL STATE ====================
        let currentUser = null;
        let currentCompany = null;
        let currentRole = null; // 'rep', 'manager', 'admin'
        let appData = {
            customers: [],
            products: [],
            invoices: [],
            payments: [],
            visits: [],
            returns: [],
            targets: [],
            companies: [],
            suggestedCustomers: [],
            reps: []
        };
        
        let syncQueue = [];
        let isOnline = navigator.onLine;
        let currentGPS = null;
        let currentMap = null;
        let geofenceRadius = 100; // meters

        // ==================== AUTHENTICATION ====================
        function switchLoginTab(tab) {
            document.querySelectorAll('.login-tab').forEach(t => {
                t.classList.remove('active');
                t.style.background = 'transparent';
                t.style.color = '#666';
            });
            event.target.classList.add('active');
            event.target.style.background = 'white';
            event.target.style.color = 'var(--primary)';
            
            document.getElementById('repInitialForm').style.display = 'none';
            document.getElementById('repCompleteForm').style.display = 'none';
            document.getElementById('repLoginForm').style.display = 'none';
            document.getElementById('managerLoginForm').style.display = 'none';
            document.getElementById('adminLoginForm').style.display = 'none';
            
            if (tab === 'rep') {
                document.getElementById('repInitialForm').style.display = 'block';
            } else if (tab === 'manager') {
                document.getElementById('managerLoginForm').style.display = 'block';
            } else {
                document.getElementById('adminLoginForm').style.display = 'block';
            }
        }

        async function loadCompanies() {
            // In real app, fetch from Supabase
            const companies = [
                { id: 1, name: 'Ø§Ù„Ø´Ø±ÙƒØ© Ø§Ù„Ø²Ø±Ø§Ø¹ÙŠØ© Ø§Ù„Ø£ÙˆÙ„Ù‰', logo: 'ğŸŒ¾' },
                { id: 2, name: 'Ø³Ù…Ø§Ø¯ Ø§Ù„Ù†ÙŠÙ„', logo: 'ğŸŒ±' },
                { id: 3, name: 'ÙƒÙŠÙ…Ø§ÙˆÙŠØ§Øª Ù…ØµØ±', logo: 'âš—ï¸' }
            ];
            
            const container = document.getElementById('companiesList');
            container.innerHTML = companies.map(c => `
                <div class="company-option" onclick="selectCompany(${c.id}, '${c.name}', '${c.logo}')" id="company-${c.id}">
                    <div class="company-logo">${c.logo}</div>
                    <div style="text-align: right; flex: 1;">
                        <div style="font-weight: 600; color: var(--dark);">${c.name}</div>
                        <div style="font-size: 12px; color: #999;">Ø§Ù†Ù‚Ø± Ù„Ù„Ø§Ø®ØªÙŠØ§Ø±</div>
                    </div>
                </div>
            `).join('');
        }

        function selectCompany(id, name, logo) {
            currentCompany = { id, name, logo };
            document.querySelectorAll('.company-option').forEach(el => {
                el.classList.remove('active');
                el.style.borderColor = '#e0e0e0';
            });
            document.getElementById(`company-${id}`).classList.add('active');
            document.getElementById(`company-${id}`).style.borderColor = 'var(--primary)';
        }

        async function checkRepRegistration() {
            const phone = document.getElementById('repPhone').value;
            if (!phone) {
                showToast('âš ï¸ Ø£Ø¯Ø®Ù„ Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ', 'warning');
                return;
            }

            // Check if rep exists
            const existingRep = appData.reps.find(r => r.phone === phone && r.companyId === currentCompany?.id);
            
            if (existingRep) {
                // Show login form
                document.getElementById('repInitialForm').style.display = 'none';
                document.getElementById('repLoginForm').style.display = 'block';
                document.getElementById('repLoginPhone').value = phone;
            } else {
                // Show registration form
                document.getElementById('repInitialForm').style.display = 'none';
                document.getElementById('repCompleteForm').style.display = 'block';
                document.getElementById('regPhoneDisplay').textContent = phone;
            }
        }

        async function completeRepRegistration() {
            if (!currentCompany) {
                showToast('âš ï¸ Ø§Ø®ØªØ± Ø§Ù„Ø´Ø±ÙƒØ© Ø£ÙˆÙ„Ø§Ù‹', 'warning');
                return;
            }

            const phone = document.getElementById('repPhone').value;
            const name = document.getElementById('repName').value;
            const password = document.getElementById('repPassword').value;
            const region = document.getElementById('repRegion').value;
            const center = document.getElementById('repCenter').value;
            const village = document.getElementById('repVillage').value;

            if (!name || !password || !region || !center) {
                showToast('âš ï¸ Ø£ÙƒÙ…Ù„ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©', 'warning');
                return;
            }

            // Create new rep
            const newRep = {
                id: 'rep_' + Date.now(),
                phone,
                name,
                password, // In real app, hash this
                companyId: currentCompany.id,
                region,
                center,
                village,
                role: 'rep',
                createdAt: new Date().toISOString(),
                isActive: true
            };

            appData.reps.push(newRep);
            
            // Save to IndexedDB
            await saveToIndexedDB();
            
            showToast('âœ… ØªÙ… Ø§Ù„ØªØ³Ø¬ÙŠÙ„ Ø¨Ù†Ø¬Ø§Ø­', 'success');
            
            // Auto login
            currentUser = newRep;
            currentRole = 'rep';
            document.getElementById('loginScreen').classList.add('hidden');
            document.getElementById('appLoader').classList.remove('hidden');
            
            setTimeout(() => initializeApp(), 1000);
        }

        async function handleLogin(role) {
            if (!currentCompany) {
                showToast('âš ï¸ Ø§Ø®ØªØ± Ø§Ù„Ø´Ø±ÙƒØ© Ø£ÙˆÙ„Ø§Ù‹', 'warning');
                return;
            }

            currentRole = role;
            
            if (role === 'rep') {
                const phone = document.getElementById('repLoginPhone').value;
                const password = document.getElementById('repLoginPassword').value;
                
                const rep = appData.reps.find(r => 
                    r.phone === phone && 
                    r.password === password && 
                    r.companyId === currentCompany.id
                );
                
                if (!rep) {
                    showToast('âŒ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¯Ø®ÙˆÙ„ ØºÙŠØ± ØµØ­ÙŠØ­Ø©', 'error');
                    return;
                }
                
                currentUser = rep;
            } else if (role === 'manager') {
                const email = document.getElementById('managerEmail').value;
                const password = document.getElementById('managerPassword').value;
                
                // Verify manager belongs to company
                currentUser = { 
                    id: 'mgr_' + currentCompany.id, 
                    name: 'Ù…Ø¯ÙŠØ± ' + currentCompany.name, 
                    email,
                    companyId: currentCompany.id,
                    role: 'manager',
                    region: 'all' // Manager can see all regions
                };
            } else {
                currentUser = { 
                    id: 'admin_1', 
                    name: 'Ø§Ù„Ø£Ø¯Ù…Ù†', 
                    role: 'admin',
                    companyId: currentCompany.id 
                };
            }

            document.getElementById('loginScreen').classList.add('hidden');
            document.getElementById('appLoader').classList.remove('hidden');
            
            setTimeout(() => initializeApp(), 1000);
        }

        // ==================== INITIALIZATION ====================
        async function initializeApp() {
            document.getElementById('appLoader').classList.add('hidden');
            document.getElementById('mainContent').style.display = 'block';
            document.getElementById('appHeader').style.display = 'flex';
            
            // Setup UI
            document.getElementById('companyName').textContent = currentCompany.logo + ' ' + currentCompany.name;
            document.getElementById('navCompanyName').textContent = currentCompany.name;
            document.getElementById('navUserName').textContent = currentUser.name;
            document.getElementById('navUserRole').textContent = 
                currentRole === 'rep' ? 'Ù…Ù†Ø¯ÙˆØ¨ Ù…Ø¨ÙŠØ¹Ø§Øª' : 
                currentRole === 'manager' ? 'Ù…Ø¯ÙŠØ± ÙØ±Ø¹' : 'Ù…Ø¯ÙŠØ± Ø§Ù„Ù†Ø¸Ø§Ù…';
            document.getElementById('navUserRegion').textContent = 
                currentUser.region === 'all' ? 'Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ù†Ø§Ø·Ù‚' : currentUser.region;
            
            // Show/hide manager sections
            if (currentRole === 'manager' || currentRole === 'admin') {
                document.querySelectorAll('.manager-only').forEach(el => el.style.display = 'block');
            }

            // Load data with company filter
            await loadData();
            
            // Setup sync and network monitoring
            setupNetworkMonitoring();
            setupBackgroundSync();
            
            // Initial renders
            updateStats();
            renderCustomers();
            initGovernorateTabs();
            generateAISuggestions();
            checkSuggestedCustomers();
            
            // Start location tracking for route optimization
            startLocationTracking();
        }

        async function loadData() {
            // Load from IndexedDB first (offline-first)
            const localData = await loadFromIndexedDB();
            if (localData) {
                appData = localData;
            } else {
                initializeMockData();
            }

            // Filter data by company and region
            filterDataByAccess();
        }

        function filterDataByAccess() {
            // Filter customers based on user access
            if (currentRole === 'rep') {
                // Rep sees only their region customers
                appData.customers = appData.customers.filter(c => 
                    c.companyId === currentCompany.id && 
                    c.region === currentUser.region &&
                    c.repId === currentUser.id
                );
            } else if (currentRole === 'manager') {
                // Manager sees all company customers
                appData.customers = appData.customers.filter(c => 
                    c.companyId === currentCompany.id
                );
            }
            // Admin sees everything (no filter)
        }

        function initializeMockData() {
            // Initialize with empty data structure
            appData = {
                customers: [],
                products: [
                    { id: 1, name: 'Ø³Ù…Ø§Ø¯ Ù†ÙŠØªØ±ÙˆØ¬ÙŠÙ†ÙŠ', price: 2500, companyId: 1 },
                    { id: 2, name: 'Ø³Ù…Ø§Ø¯ ÙÙˆØ³ÙØ§ØªÙŠ', price: 3000, companyId: 1 },
                    { id: 3, name: 'Ù…Ø¨ÙŠØ¯ Ø­Ø´Ø±ÙŠ', price: 150, companyId: 1 }
                ],
                invoices: [],
                payments: [],
                visits: [],
                returns: [],
                targets: [],
                companies: [
                    { id: 1, name: 'Ø§Ù„Ø´Ø±ÙƒØ© Ø§Ù„Ø²Ø±Ø§Ø¹ÙŠØ© Ø§Ù„Ø£ÙˆÙ„Ù‰', logo: 'ğŸŒ¾' },
                    { id: 2, name: 'Ø³Ù…Ø§Ø¯ Ø§Ù„Ù†ÙŠÙ„', logo: 'ğŸŒ±' }
                ],
                suggestedCustomers: [],
                reps: []
            };
        }

        // ==================== DATA ISOLATION & SYNC ====================
        function setupNetworkMonitoring() {
            const statusDiv = document.getElementById('connectionStatus');
            
            window.addEventListener('online', () => {
                isOnline = true;
                statusDiv.textContent = 'âœ“ Ù…ØªØµÙ„ - Ø¬Ø§Ø±ÙŠ Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø©';
                statusDiv.className = 'connection-status syncing';
                syncData();
            });
            
            window.addEventListener('offline', () => {
                isOnline = false;
                statusDiv.textContent = 'âœ— ØºÙŠØ± Ù…ØªØµÙ„ - ÙˆØ¶Ø¹ Offline';
                statusDiv.className = 'connection-status offline';
                document.getElementById('syncIndicator').classList.add('pending');
            });
        }

        function setupBackgroundSync() {
            // Register for background sync if supported
            if ('serviceWorker' in navigator && 'SyncManager' in window) {
                navigator.serviceWorker.ready.then(registration => {
                    registration.sync.register('sync-data');
                });
            }
            
            // Periodic sync every 5 minutes
            setInterval(() => {
                if (isOnline && syncQueue.length > 0) {
                    syncData();
                }
            }, 300000);
        }

        async function syncData() {
            const indicator = document.getElementById('syncIndicator');
            indicator.classList.add('syncing');
            
            try {
                // Process sync queue with company isolation
                while (syncQueue.length > 0) {
                    const item = syncQueue[0];
                    // Ensure data belongs to current company before syncing
                    if (item.companyId === currentCompany.id) {
                        await syncItemToServer(item);
                    }
                    syncQueue.shift();
                }
                
                // Fetch updates from server with company filter
                await fetchUpdatesFromServer();
                
                // Save to IndexedDB
                await saveToIndexedDB();
                
                indicator.classList.remove('syncing', 'pending', 'error');
                showToast('âœ… ØªÙ…Øª Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø© Ø¨Ù†Ø¬Ø§Ø­', 'success');
            } catch (error) {
                console.error('Sync error:', error);
                indicator.classList.add('error');
                showToast('âŒ ÙØ´Ù„Øª Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø©', 'error');
            }
        }

        async function syncItemToServer(item) {
            // In real app: Send to Supabase with company_id in RLS policy
            console.log('Syncing to server:', item);
            // Simulate API call
            await new Promise(resolve => setTimeout(resolve, 500));
        }

        async function fetchUpdatesFromServer() {
            // In real app: Fetch from Supabase with company_id filter
            // SELECT * FROM customers WHERE company_id = currentCompany.id
        }

        function queueForSync(data) {
            // Add company and user info to all synced data
            const enrichedData = {
                ...data,
                companyId: currentCompany.id,
                createdBy: currentUser.id,
                createdAt: new Date().toISOString(),
                synced: false
            };
            
            syncQueue.push(enrichedData);
            
            if (isOnline) {
                syncData();
            } else {
                document.getElementById('syncIndicator').classList.add('pending');
                showToast('ğŸ’¾ ØªÙ… Ø§Ù„Ø­ÙØ¸ Ù…Ø­Ù„ÙŠØ§Ù‹ - Ø³ÙŠØªÙ… Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø© Ø¹Ù†Ø¯ Ø§Ù„Ø§ØªØµØ§Ù„', 'info');
            }
        }

        // ==================== CUSTOMER MANAGEMENT ====================
        function openCustomerModal() {
            const modal = document.getElementById('customerModal');
            modal.style.display = 'block';
            setTimeout(() => modal.classList.add('active'), 10);
            
            // Reset form
            document.getElementById('customerName').value = '';
            document.getElementById('customerPhone').value = '';
            document.getElementById('customerGovernorate').value = currentUser.region || '';
            document.getElementById('customerCenter').value = '';
            document.getElementById('customerVillage').value = '';
            document.getElementById('customerAddress').value = '';
            document.getElementById('customerCrop').value = '';
            document.getElementById('customerArea').value = '';
            document.getElementById('customerRatingValue').value = '0';
            document.getElementById('customerPaymentMethod').value = '';
            document.getElementById('customerCreditDays').value = '';
            document.getElementById('customerNotes').value = '';
            
            // Reset stars
            document.querySelectorAll('.star').forEach(s => s.classList.remove('active'));
            
            // Reset payment methods
            document.querySelectorAll('.payment-method').forEach(p => p.classList.remove('active'));
        }

        function setRating(rating) {
            document.getElementById('customerRatingValue').value = rating;
            const stars = document.querySelectorAll('.star');
            stars.forEach((star, index) => {
                if (index < rating) star.classList.add('active');
                else star.classList.remove('active');
            });
        }

        function selectPaymentMethod(method) {
            document.getElementById('customerPaymentMethod').value = method;
            document.querySelectorAll('.payment-method').forEach(p => p.classList.remove('active'));
            event.currentTarget.classList.add('active');
            
            // Show/hide credit days
            const creditGroup = document.getElementById('creditTermsGroup');
            if (method === 'credit' || method === 'mixed') {
                creditGroup.style.display = 'block';
            } else {
                creditGroup.style.display = 'none';
            }
        }

        async function saveCustomer() {
            const customer = {
                id: 'cust_' + Date.now(),
                name: document.getElementById('customerName').value,
                phone: document.getElementById('customerPhone').value,
                governorate: document.getElementById('customerGovernorate').value,
                center: document.getElementById('customerCenter').value,
                village: document.getElementById('customerVillage').value,
                address: document.getElementById('customerAddress').value,
                crop: document.getElementById('customerCrop').value,
                area: parseFloat(document.getElementById('customerArea').value) || 0,
                region: currentUser.region,
                companyId: currentCompany.id,
                repId: currentUser.id,
                rating: parseInt(document.getElementById('customerRatingValue').value) || 0,
                paymentMethod: document.getElementById('customerPaymentMethod').value,
                creditDays: parseInt(document.getElementById('customerCreditDays').value) || 0,
                notes: document.getElementById('customerNotes').value,
                debt: 0,
                createdAt: new Date().toISOString()
            };

            if (!customer.name || !customer.phone) {
                showToast('âš ï¸ Ø£ÙƒÙ…Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ©', 'warning');
                return;
            }

            appData.customers.push(customer);
            await saveToIndexedDB();
            queueForSync({ type: 'customer', data: customer });
            
            closeModal('customerModal');
            renderCustomers();
            updateStats();
            showToast('âœ… ØªÙ… Ø­ÙØ¸ Ø§Ù„Ø¹Ù…ÙŠÙ„ Ø¨Ù†Ø¬Ø§Ø­', 'success');
        }

        // ==================== INVOICE MANAGEMENT ====================
        function openInvoiceModal() {
            const modal = document.getElementById('invoiceModal');
            modal.style.display = 'block';
            setTimeout(() => modal.classList.add('active'), 10);
            
            // Reset form
            document.getElementById('invoiceCustomerSearch').value = '';
            document.getElementById('invoiceCustomer').value = '';
            document.getElementById('customerRatingDisplay').style.display = 'none';
            document.getElementById('invoiceTotal').value = '';
            
            // Load products
            const productSelects = document.querySelectorAll('.product-select');
            productSelects.forEach(select => {
                select.innerHTML = '<option value="">Ø§Ø®ØªØ± Ø§Ù„Ù…Ù†ØªØ¬</option>' +
                    appData.products
                        .filter(p => p.companyId === currentCompany.id)
                        .map(p => `<option value="${p.id}" data-price="${p.price}">${p.name} - ${p.price} Ø¬</option>`)
                        .join('');
            });
        }

        function addInvoiceItem() {
            const container = document.getElementById('invoiceItems');
            const newItem = document.createElement('div');
            newItem.className = 'form-group invoice-item';
            newItem.innerHTML = `
                <label class="form-label">Ø§Ù„Ù…Ù†ØªØ¬</label>
                <select class="form-control product-select">
                    <option value="">Ø§Ø®ØªØ± Ø§Ù„Ù…Ù†ØªØ¬</option>
                    ${appData.products
                        .filter(p => p.companyId === currentCompany.id)
                        .map(p => `<option value="${p.id}" data-price="${p.price}">${p.name} - ${p.price} Ø¬</option>`)
                        .join('')}
                </select>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-top: 12px;">
                    <input type="number" class="form-control quantity" placeholder="Ø§Ù„ÙƒÙ…ÙŠØ©" onchange="calculateInvoiceTotal()">
                    <input type="number" class="form-control price" placeholder="Ø§Ù„Ø³Ø¹Ø±" onchange="calculateInvoiceTotal()">
                </div>
            `;
            container.appendChild(newItem);
        }

        function calculateInvoiceTotal() {
            let total = 0;
            document.querySelectorAll('.invoice-item').forEach(item => {
                const qty = parseFloat(item.querySelector('.quantity').value) || 0;
                const price = parseFloat(item.querySelector('.price').value) || 0;
                total += qty * price;
            });
            document.getElementById('invoiceTotal').value = total.toFixed(2);
        }

        async function saveInvoice() {
            const customerId = document.getElementById('invoiceCustomer').value;
            if (!customerId) {
                showToast('âš ï¸ Ø§Ø®ØªØ± Ø§Ù„Ø¹Ù…ÙŠÙ„ Ø£ÙˆÙ„Ø§Ù‹', 'warning');
                return;
            }

            const items = [];
            document.querySelectorAll('.invoice-item').forEach(item => {
                const productId = item.querySelector('.product-select').value;
                const qty = parseFloat(item.querySelector('.quantity').value) || 0;
                const price = parseFloat(item.querySelector('.price').value) || 0;
                if (productId && qty > 0) {
                    items.push({ productId, qty, price, total: qty * price });
                }
            });

            if (items.length === 0) {
                showToast('âš ï¸ Ø£Ø¶Ù Ù…Ù†ØªØ¬Ø§Øª Ù„Ù„ÙØ§ØªÙˆØ±Ø©', 'warning');
                return;
            }

            const invoice = {
                id: 'inv_' + Date.now(),
                customerId,
                customerName: appData.customers.find(c => c.id === customerId)?.name,
                items,
                total: parseFloat(document.getElementById('invoiceTotal').value),
                paymentMethod: document.getElementById('invoicePaymentMethod').value,
                companyId: currentCompany.id,
                repId: currentUser.id,
                region: currentUser.region,
                date: new Date().toISOString().split('T')[0],
                createdAt: new Date().toISOString()
            };

            // Update customer debt if credit
            if (invoice.paymentMethod === 'credit') {
                const customer = appData.customers.find(c => c.id === customerId);
                if (customer) {
                    customer.debt += invoice.total;
                }
            }

            appData.invoices.push(invoice);
            await saveToIndexedDB();
            queueForSync({ type: 'invoice', data: invoice });
            
            closeModal('invoiceModal');
            renderInvoices();
            updateStats();
            showToast('âœ… ØªÙ… Ø­ÙØ¸ Ø§Ù„ÙØ§ØªÙˆØ±Ø© Ø¨Ù†Ø¬Ø§Ø­', 'success');
        }

        // ==================== PAYMENT MANAGEMENT ====================
        function openPaymentModal() {
            const modal = document.getElementById('paymentModal');
            modal.style.display = 'block';
            setTimeout(() => modal.classList.add('active'), 10);
            
            // Reset form
            document.getElementById('paymentCustomerSearch').value = '';
            document.getElementById('paymentCustomer').value = '';
            document.getElementById('customerDebtDisplay').style.display = 'none';
            document.getElementById('paymentAmount').value = '';
            document.getElementById('paymentMethod').value = 'cash';
            document.getElementById('checkDetails').style.display = 'none';
            document.getElementById('paymentNotes').value = '';
        }

        document.getElementById('paymentMethod')?.addEventListener('change', function() {
            const checkDetails = document.getElementById('checkDetails');
            if (this.value === 'check') {
                checkDetails.style.display = 'block';
            } else {
                checkDetails.style.display = 'none';
            }
        });

        async function savePayment() {
            const customerId = document.getElementById('paymentCustomer').value;
            if (!customerId) {
                showToast('âš ï¸ Ø§Ø®ØªØ± Ø§Ù„Ø¹Ù…ÙŠÙ„ Ø£ÙˆÙ„Ø§Ù‹', 'warning');
                return;
            }

            const amount = parseFloat(document.getElementById('paymentAmount').value);
            if (!amount || amount <= 0) {
                showToast('âš ï¸ Ø£Ø¯Ø®Ù„ Ø§Ù„Ù…Ø¨Ù„Øº', 'warning');
                return;
            }

            const payment = {
                id: 'pay_' + Date.now(),
                customerId,
                customerName: appData.customers.find(c => c.id === customerId)?.name,
                amount,
                method: document.getElementById('paymentMethod').value,
                checkNumber: document.getElementById('checkNumber')?.value || null,
                checkDate: document.getElementById('checkDate')?.value || null,
                bankName: document.getElementById('bankName')?.value || null,
                notes: document.getElementById('paymentNotes').value,
                companyId: currentCompany.id,
                repId: currentUser.id,
                region: currentUser.region,
                date: new Date().toISOString().split('T')[0],
                createdAt: new Date().toISOString()
            };

            // Update customer debt
            const customer = appData.customers.find(c => c.id === customerId);
            if (customer) {
                customer.debt = Math.max(0, customer.debt - amount);
            }

            appData.payments.push(payment);
            await saveToIndexedDB();
            queueForSync({ type: 'payment', data: payment });
            
            closeModal('paymentModal');
            renderPayments();
            updateStats();
            showToast('âœ… ØªÙ… Ø­ÙØ¸ Ø§Ù„ØªØ­ØµÙŠÙ„ Ø¨Ù†Ø¬Ø§Ø­', 'success');
        }

        // ==================== SUGGESTED CUSTOMERS (MANAGER FEATURE) ====================
        function checkSuggestedCustomers() {
            if (currentRole !== 'rep') return;
            
            const suggested = appData.suggestedCustomers.filter(s => 
                s.region === currentUser.region && 
                s.companyId === currentCompany.id &&
                !s.purchasedBy
            );
            
            if (suggested.length > 0) {
                document.getElementById('suggestedAlert').style.display = 'block';
                document.getElementById('suggestedCount').textContent = suggested.length;
            }
        }

        function loadSuggestedCustomers() {
            if (currentRole !== 'manager' && currentRole !== 'admin') return;
            
            const container = document.getElementById('suggestedCustomersList');
            const regionFilter = document.getElementById('suggestedRegionFilter').value;
            
            let suggested = appData.suggestedCustomers.filter(s => 
                s.companyId === currentCompany.id &&
                !s.purchasedBy
            );
            
            if (regionFilter) {
                suggested = suggested.filter(s => s.region === regionFilter);
            }
            
            container.innerHTML = suggested.map(s => `
                <div class="list-item">
                    <div class="list-item-header">
                        <div class="list-item-title">${s.name}</div>
                        <div class="list-item-badge pending">Ù…ØªØ§Ø­</div>
                    </div>
                    <div class="list-item-meta">
                        <span>ğŸ“± ${s.phone}</span>
                        <span>ğŸ“ ${s.region} - ${s.center}</span>
                        <span>ğŸŒ¾ ${s.crop || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'}</span>
                    </div>
                    <div style="margin-top: 12px; padding: 12px; background: #f5f5f5; border-radius: 8px;">
                        <div style="font-size: 13px; color: #666; margin-bottom: 8px;">Ø§Ù„Ø³Ø¹Ø±: <strong>${s.price} Ø¬</strong></div>
                        <div style="font-size: 12px; color: #999;">Ù…Ø¶Ø§Ù Ù…Ù†Ø°: ${new Date(s.createdAt).toLocaleDateString('ar-EG')}</div>
                    </div>
                    <div class="list-item-actions">
                        <button class="btn btn-success btn-sm" onclick="purchaseSuggestedCustomer('${s.id}')">
                            <span>ğŸ›’</span>
                            <span>Ø´Ø±Ø§Ø¡ Ø§Ù„Ø¹Ù…ÙŠÙ„</span>
                        </button>
                    </div>
                </div>
            `).join('');
        }

        async function purchaseSuggestedCustomer(suggestedId) {
            const suggested = appData.suggestedCustomers.find(s => s.id === suggestedId);
            if (!suggested) return;
            
            // Transfer to regular customers
            const newCustomer = {
                id: 'cust_' + Date.now(),
                name: suggested.name,
                phone: suggested.phone,
                governorate: suggested.region,
                center: suggested.center,
                village: suggested.village,
                address: suggested.address,
                crop: suggested.crop,
                area: suggested.area,
                region: suggested.region,
                companyId: currentCompany.id,
                repId: currentUser.id,
                rating: 0,
                paymentMethod: '',
                creditDays: 0,
                notes: 'ØªÙ… Ø§Ù„Ø´Ø±Ø§Ø¡ Ù…Ù† Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡ Ø§Ù„Ù…Ù‚ØªØ±Ø­ÙŠÙ†',
                debt: 0,
                createdAt: new Date().toISOString(),
                source: 'purchased',
                purchasePrice: suggested.price,
                purchasedAt: new Date().toISOString()
            };
            
            appData.customers.push(newCustomer);
            suggested.purchasedBy = currentUser.id;
            suggested.purchasedAt = new Date().toISOString();
            
            await saveToIndexedDB();
            queueForSync({ type: 'customer', data: newCustomer });
            queueForSync({ type: 'suggested_purchase', data: { suggestedId, repId: currentUser.id } });
            
            loadSuggestedCustomers();
            renderCustomers();
            updateStats();
            showToast('âœ… ØªÙ… Ø´Ø±Ø§Ø¡ Ø§Ù„Ø¹Ù…ÙŠÙ„ Ø¨Ù†Ø¬Ø§Ø­', 'success');
        }

        // ==================== GPS & GEOFENCING ====================
        async function captureLocationWithValidation() {
            const btn = document.getElementById('gpsBtn');
            const statusDiv = document.getElementById('gpsStatus');
            
            btn.classList.add('loading');
            btn.disabled = true;
            document.getElementById('gpsBtnIcon').innerHTML = '<div class="spinner" style="width: 20px; height: 20px; border: 2px solid rgba(255,255,255,0.3); border-top-color: white; border-radius: 50%; animation: rotate 1s linear infinite;"></div>';
            document.getElementById('gpsBtnText').textContent = 'Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ù…ÙˆÙ‚Ø¹...';
            
            try {
                const position = await getHighAccuracyPosition();
                currentGPS = {
                    lat: position.coords.latitude,
                    lng: position.coords.longitude,
                    accuracy: position.coords.accuracy,
                    timestamp: new Date().toISOString(),
                    speed: position.coords.speed,
                    altitude: position.coords.altitude
                };
                
                const validation = validateGPS(currentGPS);
                if (!validation.valid) {
                    throw new Error(validation.reason);
                }
                
                statusDiv.classList.add('active');
                document.getElementById('gpsStatusIcon').textContent = 'âœ…';
                document.getElementById('gpsStatusText').textContent = 'ØªÙ… ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù…ÙˆÙ‚Ø¹';
                document.getElementById('gpsAccuracy').textContent = `Ø§Ù„Ø¯Ù‚Ø©: Â±${Math.round(currentGPS.accuracy)} Ù…ØªØ±`;
                
                // Check geofence
                const customerId = document.getElementById('visitCustomer').value;
                if (customerId) {
                    const customer = appData.customers.find(c => c.id == customerId);
                    if (customer && customer.gps) {
                        const distance = calculateDistance(
                            currentGPS.lat, currentGPS.lng,
                            parseFloat(customer.gps.split(',')[0]),
                            parseFloat(customer.gps.split(',')[1])
                        );
                        
                        const geofenceDiv = document.getElementById('geofenceResult');
                        geofenceDiv.style.display = 'block';
                        
                        if (distance <= geofenceRadius) {
                            geofenceDiv.style.background = 'rgba(39, 174, 96, 0.2)';
                            geofenceDiv.style.color = '#27ae60';
                            geofenceDiv.innerHTML = `âœ… Ø¯Ø§Ø®Ù„ Ù†Ø·Ø§Ù‚ Ø§Ù„Ø¹Ù…ÙŠÙ„ (${Math.round(distance)}Ù…)`;
                            document.getElementById('saveVisitBtn').disabled = false;
                        } else {
                            geofenceDiv.style.background = 'rgba(231, 76, 60, 0.2)';
                            geofenceDiv.style.color = '#e74c3c';
                            geofenceDiv.innerHTML = `âŒ Ø®Ø§Ø±Ø¬ Ø§Ù„Ù†Ø·Ø§Ù‚ (${Math.round(distance)}Ù…)<br>ÙŠØ¬Ø¨ Ø£Ù† ØªÙƒÙˆÙ† Ø¶Ù…Ù† ${geofenceRadius} Ù…ØªØ±`;
                            document.getElementById('saveVisitBtn').disabled = true;
                            
                            const alert = document.getElementById('geofenceAlert');
                            alert.classList.add('active');
                            setTimeout(() => alert.classList.remove('active'), 5000);
                        }
                    }
                }
                
                initMap(currentGPS.lat, currentGPS.lng);
                
                btn.classList.remove('loading');
                btn.classList.add('success');
                document.getElementById('gpsBtnIcon').textContent = 'âœ…';
                document.getElementById('gpsBtnText').textContent = 'Ø§Ù„Ù…ÙˆÙ‚Ø¹ ØµØ­ÙŠØ­';
                
            } catch (error) {
                btn.classList.remove('loading');
                btn.classList.add('error');
                document.getElementById('gpsBtnIcon').textContent = 'âŒ';
                document.getElementById('gpsBtnText').textContent = 'Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø©';
                showToast('âš ï¸ ' + error.message, 'warning');
            }
        }

        function getHighAccuracyPosition() {
            return new Promise((resolve, reject) => {
                const options = {
                    enableHighAccuracy: true,
                    timeout: 20000,
                    maximumAge: 0
                };
                
                let bestPosition = null;
                let attempts = 0;
                const maxAttempts = 15;
                
                const watchId = navigator.geolocation.watchPosition(
                    (position) => {
                        attempts++;
                        if (!bestPosition || position.coords.accuracy < bestPosition.coords.accuracy) {
                            bestPosition = position;
                        }
                        
                        if (position.coords.accuracy <= 20 || attempts >= maxAttempts) {
                            navigator.geolocation.clearWatch(watchId);
                            resolve(bestPosition);
                        }
                    },
                    (error) => {
                        navigator.geolocation.clearWatch(watchId);
                        reject(error);
                    },
                    options
                );
                
                setTimeout(() => {
                    navigator.geolocation.clearWatch(watchId);
                    if (bestPosition) {
                        resolve(bestPosition);
                    } else {
                        reject(new Error('timeout'));
                    }
                }, 25000);
            });
        }

        function validateGPS(gps) {
            if (gps.accuracy > 100) {
                return { valid: false, reason: 'Ø¯Ù‚Ø© Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ù…Ù†Ø®ÙØ¶Ø© Ø¬Ø¯Ø§Ù‹ØŒ Ø­Ø§ÙˆÙ„ ÙÙŠ Ù…ÙƒØ§Ù† Ù…ÙØªÙˆØ­' };
            }
            
            if (gps.speed > 10) {
                return { valid: false, reason: 'ÙŠØ¨Ø¯Ùˆ Ø£Ù†Ùƒ ÙÙŠ Ø³ÙŠØ§Ø±Ø©ØŒ ØªÙˆÙ‚Ù Ø¹Ù†Ø¯ Ø§Ù„Ø¹Ù…ÙŠÙ„' };
            }
            
            if (gps.altitude && (gps.altitude < -50 || gps.altitude > 5000)) {
                return { valid: false, reason: 'Ø¨ÙŠØ§Ù†Ø§Øª GPS ØºÙŠØ± Ø·Ø¨ÙŠØ¹ÙŠØ©' };
            }
            
            if (gps.accuracy === 0 || gps.accuracy === 1) {
                return { valid: false, reason: 'ØªÙ… Ø§ÙƒØªØ´Ø§Ù Ù…Ø­Ø§ÙƒØ§Ø© GPS' };
            }
            
            return { valid: true };
        }

        function calculateDistance(lat1, lng1, lat2, lng2) {
            const R = 6371e3;
            const Ï†1 = lat1 * Math.PI / 180;
            const Ï†2 = lat2 * Math.PI / 180;
            const Î”Ï† = (lat2 - lat1) * Math.PI / 180;
            const Î”Î» = (lng2 - lng1) * Math.PI / 180;
            
            const a = Math.sin(Î”Ï†/2) * Math.sin(Î”Ï†/2) +
                      Math.cos(Ï†1) * Math.cos(Ï†2) *
                      Math.sin(Î”Î»/2) * Math.sin(Î”Î»/2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
            
            return R * c;
        }

        function initMap(lat, lng) {
            const container = document.getElementById('staticMap');
            container.style.display = 'block';
            container.classList.add('active');
            
            if (currentMap) {
                currentMap.remove();
            }
            
            currentMap = L.map('staticMap', {
                center: [lat, lng],
                zoom: 17,
                zoomControl: false
            });
            
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                maxZoom: 19
            }).addTo(currentMap);
            
            L.marker([lat, lng]).addTo(currentMap)
                .bindPopup('Ù…ÙˆÙ‚Ø¹Ùƒ Ø§Ù„Ø­Ø§Ù„ÙŠ')
                .openPopup();
            
            if (currentGPS.accuracy > 0) {
                L.circle([lat, lng], {
                    radius: currentGPS.accuracy,
                    color: '#3498db',
                    fillColor: '#3498db',
                    fillOpacity: 0.2
                }).addTo(currentMap);
            }
            
            const customerId = document.getElementById('visitCustomer').value;
            if (customerId) {
                const customer = appData.customers.find(c => c.id == customerId);
                if (customer && customer.gps) {
                    const [cLat, cLng] = customer.gps.split(',').map(parseFloat);
                    L.marker([cLat, cLng], {
                        icon: L.divIcon({
                            className: 'custom-marker',
                            html: '<div style="background: #e74c3c; width: 24px; height: 24px; border-radius: 50%; border: 3px solid white; box-shadow: 0 2px 5px rgba(0,0,0,0.3);"></div>'
                        })
                    }).addTo(currentMap).bindPopup('Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø¹Ù…ÙŠÙ„');
                    
                    L.circle([cLat, cLng], {
                        radius: geofenceRadius,
                        color: '#e74c3c',
                        fillColor: '#e74c3c',
                        fillOpacity: 0.1,
                        dashArray: '5, 10'
                    }).addTo(currentMap);
                }
            }
        }

        // ==================== ROUTE PLANNER ====================
        function startLocationTracking() {
            if ('geolocation' in navigator) {
                navigator.geolocation.watchPosition(
                    (position) => {},
                    null,
                    { enableHighAccuracy: true, maximumAge: 30000 }
                );
            }
        }

        async function generateOptimalRoute() {
            const today = new Date().toISOString().split('T')[0];
            const overdueCustomers = appData.customers.filter(c => {
                if (!c.lastVisit) return true;
                const daysSince = Math.floor((new Date() - new Date(c.lastVisit)) / (1000 * 60 * 60 * 24));
                return daysSince > 7;
            });
            
            const prioritized = overdueCustomers.map(c => {
                const daysSince = c.lastVisit ? 
                    Math.floor((new Date() - new Date(c.lastVisit)) / (1000 * 60 * 60 * 24)) : 999;
                const priority = (c.debt * 0.7) + (daysSince * 100);
                return { ...c, daysSince, priority };
            }).sort((a, b) => b.priority - a.priority);
            
            const routeCustomers = prioritized.slice(0, 8);
            const optimizedRoute = await optimizeRoute(routeCustomers);
            displayRoute(optimizedRoute);
        }

        async function optimizeRoute(customers) {
            if (!currentGPS || customers.length === 0) return customers;
            
            let current = { lat: currentGPS.lat, lng: currentGPS.lng };
            const unvisited = [...customers];
            const route = [];
            
            while (unvisited.length > 0) {
                let nearest = null;
                let minDist = Infinity;
                
                for (let i = 0; i < unvisited.length; i++) {
                    if (!unvisited[i].gps) continue;
                    const [lat, lng] = unvisited[i].gps.split(',').map(parseFloat);
                    const dist = calculateDistance(current.lat, current.lng, lat, lng);
                    if (dist < minDist) {
                        minDist = dist;
                        nearest = i;
                    }
                }
                
                if (nearest !== null) {
                    const customer = unvisited.splice(nearest, 1)[0];
                    const [lat, lng] = customer.gps.split(',').map(parseFloat);
                    current = { lat, lng };
                    route.push({ ...customer, distance: minDist });
                } else {
                    break;
                }
            }
            
            return route;
        }

        function displayRoute(route) {
            document.getElementById('routeStats').style.display = 'block';
            document.getElementById('routeVisitsCount').textContent = route.length;
            
            const totalDistance = route.reduce((sum, c, i) => {
                if (i === 0) return sum + c.distance;
                const prev = route[i-1];
                const [prevLat, prevLng] = prev.gps.split(',').map(parseFloat);
                const [currLat, currLng] = c.gps.split(',').map(parseFloat);
                return sum + calculateDistance(prevLat, prevLng, currLat, currLng);
            }, 0);
            
            document.getElementById('routeTotalDistance').textContent = (totalDistance / 1000).toFixed(1) + ' ÙƒÙ…';
            
            const container = document.getElementById('routeList');
            container.innerHTML = route.map((c, i) => `
                <div class="route-card">
                    <div class="route-header">
                        <div style="display: flex; align-items: center; gap: 12px;">
                            <div class="route-sequence">${i + 1}</div>
                            <div>
                                <div style="font-weight: 700; font-size: 16px;">${c.name}</div>
                                <div style="font-size: 13px; color: #666; margin-top: 4px;">
                                    ğŸ“ ${c.governorate} - ${c.center}
                                </div>
                            </div>
                        </div>
                        <div class="route-distance">
                            ğŸš— ${i === 0 ? (c.distance / 1000).toFixed(1) : calculateDistanceFromPrev(route, i)} ÙƒÙ…
                        </div>
                    </div>
                    <div style="display: flex; gap: 8px; margin-top: 12px;">
                        <button class="btn btn-success btn-sm" onclick="openVisitModal(); selectCustomerById('${c.id}');" style="flex: 1;">
                            ğŸ“ Ø²ÙŠØ§Ø±Ø©
                        </button>
                        <button class="btn btn-primary btn-sm" onclick="openInvoiceModal(); selectCustomerById('${c.id}');" style="flex: 1;">
                            ğŸ§¾ ÙØ§ØªÙˆØ±Ø©
                        </button>
                        ${c.debt > 0 ? `<button class="btn btn-warning btn-sm" onclick="openPaymentModal(); selectCustomerById('${c.id}');" style="flex: 1;">ğŸ’µ ØªØ­ØµÙŠÙ„</button>` : ''}
                    </div>
                    ${c.debt > 0 ? `<div style="margin-top: 12px; padding: 10px; background: rgba(231, 76, 60, 0.1); border-radius: 8px; color: var(--danger); font-size: 13px; text-align: center;">ğŸ’° Ù…Ø¯ÙŠÙ†: ${c.debt.toLocaleString()} Ø¬</div>` : ''}
                </div>
            `).join('');
        }

        function calculateDistanceFromPrev(route, index) {
            if (index === 0) return '0.0';
            const prev = route[index - 1];
            const curr = route[index];
            const [prevLat, prevLng] = prev.gps.split(',').map(parseFloat);
            const [currLat, currLng] = curr.gps.split(',').map(parseFloat);
            const dist = calculateDistance(prevLat, prevLng, currLat, currLng);
            return (dist / 1000).toFixed(1);
        }

        // ==================== AGING REPORT ====================
        function renderAgingReport() {
            const today = new Date();
            const agingData = {};
            
            appData.customers.forEach(c => {
                if (c.debt <= 0) return;
                
                const lastInvoice = appData.invoices
                    .filter(i => i.customerId === c.id && i.paymentMethod === 'credit')
                    .sort((a, b) => new Date(b.date) - new Date(a.date))[0];
                
                if (!lastInvoice) return;
                
                const days = Math.floor((today - new Date(lastInvoice.date)) / (1000 * 60 * 60 * 24));
                
                agingData[c.name] = {
                    customer: c,
                    total: c.debt,
                    days: days,
                    buckets: { 30: 0, 60: 0, 90: 0, plus: 0 }
                };
                
                if (days <= 30) agingData[c.name].buckets[30] = c.debt;
                else if (days <= 60) agingData[c.name].buckets[60] = c.debt;
                else if (days <= 90) agingData[c.name].buckets[90] = c.debt;
                else agingData[c.name].buckets.plus = c.debt;
            });
            
            const totals = { 30: 0, 60: 0, 90: 0, plus: 0 };
            Object.values(agingData).forEach(d => {
                totals[30] += d.buckets[30];
                totals[60] += d.buckets[60];
                totals[90] += d.buckets[90];
                totals.plus += d.buckets.plus;
            });
            
            document.getElementById('aging30').textContent = totals[30].toLocaleString();
            document.getElementById('aging60').textContent = totals[60].toLocaleString();
            document.getElementById('aging90').textContent = totals[90].toLocaleString();
            document.getElementById('agingPlus').textContent = totals.plus.toLocaleString();
            
            const tbody = document.getElementById('agingTableBody');
            tbody.innerHTML = Object.values(agingData).map(d => {
                let statusClass = 'aging-30';
                let statusText = 'Ø­Ø§Ù„ÙŠ';
                if (d.days > 90) { statusClass = 'aging-90'; statusText = 'Ù…ØªØ£Ø®Ø± Ø¬Ø¯Ø§Ù‹'; }
                else if (d.days > 60) { statusClass = 'aging-60'; statusText = 'Ù…ØªØ£Ø®Ø±'; }
                else if (d.days > 30) { statusClass = 'aging-60'; statusText = 'ÙŠØ­ØªØ§Ø¬ Ù…ØªØ§Ø¨Ø¹Ø©'; }
                
                return `
                    <tr>
                        <td style="font-weight: 600;">${d.customer.name}</td>
                        <td style="font-weight: bold; color: var(--danger);">${d.total.toLocaleString()}</td>
                        <td>${d.buckets[30].toLocaleString()}</td>
                        <td>${d.buckets[60].toLocaleString()}</td>
                        <td>${d.buckets[90].toLocaleString()}</td>
                        <td>${d.buckets.plus.toLocaleString()}</td>
                        <td><span class="aging-badge ${statusClass}">${statusText}</span></td>
                    </tr>
                `;
            }).join('');
        }

        // ==================== AI SUGGESTIONS ====================
        function generateAISuggestions() {
            const suggestions = [];
            
            const critical = appData.customers.filter(c => {
                if (!c.lastVisit) return true;
                const days = Math.floor((new Date() - new Date(c.lastVisit)) / (1000 * 60 * 60 * 24));
                return days > 15 && c.debt > 10000;
            });
            
            if (critical.length > 0) {
                const c = critical[0];
                suggestions.push(`ğŸ’¡ <strong>Ø£ÙˆÙ„ÙˆÙŠØ© Ù‚ØµÙˆÙ‰:</strong> Ø²ÙŠØ§Ø±Ø© "${c.name}" - Ù„Ù… ÙŠÙØ²Ø± Ù…Ù† ${Math.floor((new Date() - new Date(c.lastVisit)) / (1000 * 60 * 60 * 24))} ÙŠÙˆÙ… ÙˆØ¹Ù„ÙŠÙ‡ ${c.debt.toLocaleString()} Ø¬`);
            }
            
            if (currentGPS && appData.customers.length > 0) {
                const withGPS = appData.customers.filter(c => c.gps);
                if (withGPS.length > 0) {
                    let nearest = withGPS[0];
                    let minDist = Infinity;
                    withGPS.forEach(c => {
                        const [lat, lng] = c.gps.split(',').map(parseFloat);
                        const dist = calculateDistance(currentGPS.lat, currentGPS.lng, lat, lng);
                        if (dist < minDist) {
                            minDist = dist;
                            nearest = c;
                        }
                    });
                    suggestions.push(`ğŸ¯ <strong>Ø£Ù‚Ø±Ø¨ Ø¹Ù…ÙŠÙ„:</strong> "${nearest.name}" Ø¹Ù„Ù‰ Ø¨Ø¹Ø¯ ${(minDist / 1000).toFixed(1)} ÙƒÙ…`);
                }
            }
            
            const target = appData.targets.find(t => t.repId === currentUser.id && t.month === new Date().toISOString().slice(0, 7));
            if (target) {
                const remaining = target.amount - target.achieved;
                const daysLeft = 30 - new Date().getDate();
                const dailyNeeded = remaining / daysLeft;
                suggestions.push(`ğŸ“Š <strong>Ø§Ù„ØªØ§Ø±Ø¬Øª:</strong> ØªØ­ØªØ§Ø¬ ${dailyNeeded.toLocaleString()} Ø¬/ÙŠÙˆÙ… Ù„ØªØ­Ù‚ÙŠÙ‚ Ø§Ù„Ù‡Ø¯Ù`);
            }
            
            document.getElementById('aiSuggestionsList').innerHTML = suggestions.map(s => 
                `<div style="padding: 12px; background: rgba(255,255,255,0.1); border-radius: 12px; margin-bottom: 8px;">${s}</div>`
            ).join('');
        }

        // ==================== KPI DASHBOARD ====================
        function updateKPIs() {
            const today = new Date().toISOString().split('T')[0];
            const todayInvoices = appData.invoices.filter(i => i.date === today && i.repId === currentUser.id);
            const todaySales = todayInvoices.reduce((sum, i) => sum + i.total, 0);
            const todayVisits = appData.visits.filter(v => v.date === today && v.repId === currentUser.id).length;
            
            const conversionRate = todayVisits > 0 ? (todayInvoices.length / todayVisits * 100).toFixed(1) : 0;
            
            const currentMonth = new Date().toISOString().slice(0, 7);
            const target = appData.targets.find(t => t.repId === currentUser.id && t.month === currentMonth);
            const targetAmount = target ? target.amount : 100000;
            const achieved = target ? target.achieved : 0;
            const progress = Math.min(100, (achieved / targetAmount * 100)).toFixed(1);
            
            document.getElementById('kpiTodaySales').textContent = todaySales.toLocaleString();
            document.getElementById('kpiTodayVisits').textContent = todayVisits;
            document.getElementById('kpiConversion').textContent = conversionRate + '%';
            document.getElementById('kpiTargetProgress').textContent = progress + '%';
            document.getElementById('kpiTargetBar').style.width = progress + '%';
            
            document.getElementById('monthlyTarget').textContent = targetAmount.toLocaleString() + ' Ø¬.Ù…';
            document.getElementById('achievedTarget').textContent = achieved.toLocaleString() + ' Ø¬.Ù…';
            document.getElementById('targetProgressBar').style.width = progress + '%';
            document.getElementById('targetPercentage').textContent = progress + '%';
            
            const avgInvoice = todayInvoices.length > 0 ? (todaySales / todayInvoices.length).toFixed(0) : 0;
            document.getElementById('kpiAvgInvoice').textContent = Number(avgInvoice).toLocaleString();
            
            const activeCustomers = new Set(appData.invoices.filter(i => i.repId === currentUser.id).map(i => i.customerId)).size;
            document.getElementById('kpiActiveCustomers').textContent = activeCustomers;
            
            const daysInMonth = new Date().getDate();
            const avgVisitsPerDay = (appData.visits.filter(v => v.date.startsWith(currentMonth) && v.repId === currentUser.id).length / daysInMonth).toFixed(1);
            document.getElementById('kpiVisitsPerDay').textContent = avgVisitsPerDay;
            
            const totalCredit = appData.invoices.filter(i => i.paymentMethod === 'credit' && i.repId === currentUser.id).reduce((sum, i) => sum + i.total, 0);
            const totalPayments = appData.payments.filter(p => p.repId === currentUser.id).reduce((sum, p) => sum + p.amount, 0);
            const collectionRate = totalCredit > 0 ? (totalPayments / totalCredit * 100).toFixed(1) : 0;
            document.getElementById('kpiCollectionRate').textContent = collectionRate + '%';
        }

        // ==================== HELPER FUNCTIONS ====================
        function showToast(message, type = 'success') {
            const container = document.getElementById('toastContainer');
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.innerHTML = `<span>${type === 'success' ? 'âœ“' : type === 'error' ? 'âœ—' : 'âš '}</span><span>${message}</span>`;
            container.appendChild(toast);
            setTimeout(() => {
                toast.style.opacity = '0';
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        }

        function toggleNav() {
            const nav = document.getElementById('sideNav');
            const overlay = document.getElementById('navOverlay');
            nav.classList.toggle('active');
            overlay.classList.toggle('active');
        }

        function closeNav() {
            document.getElementById('sideNav').classList.remove('active');
            document.getElementById('navOverlay').classList.remove('active');
        }

        function navigateTo(section) {
            document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
            document.getElementById(section).classList.add('active');
            closeNav();
            
            if (section === 'aging') renderAgingReport();
            if (section === 'kpi') updateKPIs();
            if (section === 'routePlanner') generateOptimalRoute();
            if (section === 'suggestedCustomers') loadSuggestedCustomers();
            if (section === 'invoices') renderInvoices();
            if (section === 'payments') renderPayments();
            if (section === 'visits') renderVisits();
        }

        function showSection(section) {
            navigateTo(section);
        }

        function closeModal(modalId) {
            document.getElementById(modalId).classList.remove('active');
            setTimeout(() => {
                document.getElementById(modalId).style.display = 'none';
            }, 300);
        }

        function logout() {
            if (confirm('ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬ØŸ')) {
                location.reload();
            }
        }

        function searchCustomers(query, type) {
            const filtered = appData.customers.filter(c => 
                c.name.includes(query) || 
                c.phone.includes(query) || 
                c.address?.includes(query)
            );
            
            // Show dropdown with results (simplified)
            if (filtered.length > 0 && query.length > 2) {
                const customer = filtered[0]; // Auto-select first match for demo
                if (type === 'visit') {
                    document.getElementById('visitCustomer').value = customer.id;
                    document.getElementById('visitCustomerSearch').value = customer.name;
                } else if (type === 'invoice') {
                    document.getElementById('invoiceCustomer').value = customer.id;
                    document.getElementById('invoiceCustomerSearch').value = customer.name;
                    showCustomerRating(customer);
                } else if (type === 'payment') {
                    document.getElementById('paymentCustomer').value = customer.id;
                    document.getElementById('paymentCustomerSearch').value = customer.name;
                    showCustomerDebt(customer);
                }
            }
        }

        function showCustomerRating(customer) {
            const display = document.getElementById('customerRatingDisplay');
            display.style.display = 'block';
            
            // Show stars
            const stars = 'â­'.repeat(customer.rating || 0) + 'â˜†'.repeat(5 - (customer.rating || 0));
            document.getElementById('displayRatingStars').textContent = stars;
            
            // Show payment method
            const methodNames = {
                'cash': 'ÙƒØ§Ø´',
                'credit': 'Ø¢Ø¬Ù„',
                'checks': 'Ø´ÙŠÙƒØ§Øª',
                'mixed': 'Ù…Ø®ØªÙ„Ø·'
            };
            document.getElementById('displayPaymentMethod').textContent = methodNames[customer.paymentMethod] || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯';
            
            // Show credit days if applicable
            if (customer.creditDays > 0) {
                document.getElementById('displayCreditDays').style.display = 'block';
                document.getElementById('displayCreditDays').querySelector('span').textContent = customer.creditDays;
            } else {
                document.getElementById('displayCreditDays').style.display = 'none';
            }
        }

        function showCustomerDebt(customer) {
            const display = document.getElementById('customerDebtDisplay');
            display.style.display = 'block';
            document.getElementById('displayDebtAmount').textContent = customer.debt.toLocaleString() + ' Ø¬';
        }

        function selectCustomerById(id) {
            const customer = appData.customers.find(c => c.id === id);
            if (customer) {
                // Try to find which modal is open and set the customer
                if (document.getElementById('visitModal').classList.contains('active')) {
                    document.getElementById('visitCustomer').value = id;
                    document.getElementById('visitCustomerSearch').value = customer.name;
                } else if (document.getElementById('invoiceModal').classList.contains('active')) {
                    document.getElementById('invoiceCustomer').value = id;
                    document.getElementById('invoiceCustomerSearch').value = customer.name;
                    showCustomerRating(customer);
                } else if (document.getElementById('paymentModal').classList.contains('active')) {
                    document.getElementById('paymentCustomer').value = id;
                    document.getElementById('paymentCustomerSearch').value = customer.name;
                    showCustomerDebt(customer);
                }
            }
        }

        async function saveVisit() {
            const customerId = document.getElementById('visitCustomer').value;
            if (!customerId || !currentGPS) {
                showToast('âš ï¸ Ø£ÙƒÙ…Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©', 'warning');
                return;
            }

            const visit = {
                id: 'visit_' + Date.now(),
                customerId,
                customerName: appData.customers.find(c => c.id === customerId)?.name,
                notes: document.getElementById('visitNotes').value,
                gps: `${currentGPS.lat},${currentGPS.lng}`,
                accuracy: currentGPS.accuracy,
                companyId: currentCompany.id,
                repId: currentUser.id,
                region: currentUser.region,
                date: new Date().toISOString().split('T')[0],
                createdAt: new Date().toISOString()
            };

            // Update customer's last visit
            const customer = appData.customers.find(c => c.id === customerId);
            if (customer) {
                customer.lastVisit = visit.date;
            }

            appData.visits.push(visit);
            await saveToIndexedDB();
            queueForSync({ type: 'visit', data: visit });
            
            closeModal('visitModal');
            renderVisits();
            updateStats();
            showToast('âœ… ØªÙ… Ø­ÙØ¸ Ø§Ù„Ø²ÙŠØ§Ø±Ø© Ø¨Ù†Ø¬Ø§Ø­', 'success');
        }

        function renderCustomers() {
            const container = document.getElementById('customersList');
            container.innerHTML = appData.customers.map(c => `
                <div class="list-item" onclick="showCustomerDetails('${c.id}')">
                    <div class="list-item-header">
                        <div class="list-item-title">${c.name}</div>
                        <div class="list-item-badge ${c.debt > 0 ? 'credit' : 'cash'}">${c.debt > 0 ? c.debt.toLocaleString() + ' Ø¬' : '0'}</div>
                    </div>
                    <div class="list-item-meta">
                        <span>ğŸ“± ${c.phone}</span>
                        <span>ğŸ“ ${c.governorate}</span>
                        <span>ğŸŒ¾ ${c.crop || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'}</span>
                        ${c.rating > 0 ? `<span>â­ ${c.rating}/5</span>` : ''}
                    </div>
                    ${c.paymentMethod ? `<div style="margin-top: 8px; font-size: 12px; color: #666;">Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ø¯ÙØ¹: ${getPaymentMethodName(c.paymentMethod)}</div>` : ''}
                </div>
            `).join('');
        }

        function getPaymentMethodName(method) {
            const names = {
                'cash': 'ÙƒØ§Ø´',
                'credit': 'Ø¢Ø¬Ù„',
                'checks': 'Ø´ÙŠÙƒØ§Øª',
                'mixed': 'Ù…Ø®ØªÙ„Ø·'
            };
            return names[method] || method;
        }

        function renderInvoices() {
            const container = document.getElementById('invoicesList');
            const userInvoices = appData.invoices.filter(i => i.repId === currentUser.id);
            container.innerHTML = userInvoices.map(i => `
                <div class="list-item">
                    <div class="list-item-header">
                        <div class="list-item-title">${i.customerName}</div>
                        <div class="list-item-badge ${i.paymentMethod === 'credit' ? 'credit' : 'cash'}">${i.total.toLocaleString()} Ø¬</div>
                    </div>
                    <div class="list-item-meta">
                        <span>ğŸ“… ${i.date}</span>
                        <span>ğŸ§¾ ${i.items.length} Ù…Ù†ØªØ¬</span>
                        <span>${getPaymentMethodName(i.paymentMethod)}</span>
                    </div>
                </div>
            `).join('');
        }

        function renderPayments() {
            const container = document.getElementById('paymentsList');
            const userPayments = appData.payments.filter(p => p.repId === currentUser.id);
            container.innerHTML = userPayments.map(p => `
                <div class="list-item">
                    <div class="list-item-header">
                        <div class="list-item-title">${p.customerName}</div>
                        <div class="list-item-badge success">${p.amount.toLocaleString()} Ø¬</div>
                    </div>
                    <div class="list-item-meta">
                        <span>ğŸ“… ${p.date}</span>
                        <span>${getPaymentMethodName(p.method)}</span>
                    </div>
                </div>
            `).join('');
        }

        function renderVisits() {
            const container = document.getElementById('visitsList');
            const userVisits = appData.visits.filter(v => v.repId === currentUser.id);
            container.innerHTML = userVisits.map(v => `
                <div class="list-item">
                    <div class="list-item-header">
                        <div class="list-item-title">${v.customerName}</div>
                        <div class="list-item-badge approved">âœ“</div>
                    </div>
                    <div class="list-item-meta">
                        <span>ğŸ“… ${v.date}</span>
                        <span>ğŸ“ ${v.gps ? 'ØªÙ… Ø§Ù„ØªØ­Ù‚Ù‚' : 'Ø¨Ø¯ÙˆÙ† GPS'}</span>
                    </div>
                    ${v.notes ? `<div style="margin-top: 8px; font-size: 13px; color: #666;">${v.notes}</div>` : ''}
                </div>
            `).join('');
        }

        function handleSearch(query) {
            const filtered = appData.customers.filter(c => 
                c.name.includes(query) || 
                c.phone.includes(query) || 
                c.address?.includes(query)
            );
            renderCustomersList(filtered);
        }

        function renderCustomersList(customers) {
            const container = document.getElementById('customersList');
            container.innerHTML = customers.map(c => `
                <div class="list-item" onclick="showCustomerDetails('${c.id}')">
                    <div class="list-item-header">
                        <div class="list-item-title">${c.name}</div>
                        <div class="list-item-badge ${c.debt > 0 ? 'credit' : 'cash'}">${c.debt > 0 ? c.debt.toLocaleString() + ' Ø¬' : '0'}</div>
                    </div>
                    <div class="list-item-meta">
                        <span>ğŸ“± ${c.phone}</span>
                        <span>ğŸ“ ${c.governorate}</span>
                        <span>ğŸŒ¾ ${c.crop || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'}</span>
                    </div>
                </div>
            `).join('');
        }

        function showCustomerDetails(customerId) {
            // Implementation for showing customer details modal
            showToast('ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø¹Ù…ÙŠÙ„ - Ù‚ÙŠØ¯ Ø§Ù„ØªØ·ÙˆÙŠØ±', 'info');
        }

        function initGovernorateTabs() {
            // Initialize governorate filter tabs
            const governorates = [...new Set(appData.customers.map(c => c.governorate))];
            const container = document.getElementById('customersGovTabs');
            if (container && governorates.length > 0) {
                container.innerHTML = '<button class="btn btn-sm" onclick="filterByGov(\'\')" style="min-width: 80px;">Ø§Ù„ÙƒÙ„</button>' +
                    governorates.map(g => `<button class="btn btn-sm" onclick="filterByGov('${g}')" style="min-width: 80px;">${g}</button>`).join('');
            }
        }

        function filterByGov(gov) {
            if (!gov) {
                renderCustomers();
            } else {
                const filtered = appData.customers.filter(c => c.governorate === gov);
                renderCustomersList(filtered);
            }
        }

        function updateStats() {
            document.getElementById('navTotalCustomers').textContent = appData.customers.length;
            const todaySales = appData.invoices
                .filter(i => i.date === new Date().toISOString().split('T')[0] && i.repId === currentUser.id)
                .reduce((sum, i) => sum + i.total, 0);
            document.getElementById('navTodaySales').textContent = (todaySales / 1000).toFixed(1) + 'k';
        }

        function manualSync() { 
            syncData(); 
        }

        // IndexedDB helpers
        async function saveToIndexedDB() {
            return new Promise((resolve, reject) => {
                const request = indexedDB.open('KemetChemDB', 1);
                
                request.onerror = () => reject(request.error);
                request.onsuccess = () => {
                    const db = request.result;
                    const transaction = db.transaction(['data'], 'readwrite');
                    const store = transaction.objectStore('data');
                    
                    const dataToSave = {
                        id: 'appData',
                        ...appData,
                        lastUpdated: new Date().toISOString()
                    };
                    
                    store.put(dataToSave);
                    transaction.oncomplete = () => resolve();
                    transaction.onerror = () => reject(transaction.error);
                };
                
                request.onupgradeneeded = (event) => {
                    const db = event.target.result;
                    if (!db.objectStoreNames.contains('data')) {
                        db.createObjectStore('data', { keyPath: 'id' });
                    }
                };
            });
        }

        async function loadFromIndexedDB() {
            return new Promise((resolve) => {
                const request = indexedDB.open('KemetChemDB', 1);
                
                request.onerror = () => resolve(null);
                request.onsuccess = () => {
                    const db = request.result;
                    if (!db.objectStoreNames.contains('data')) {
                        resolve(null);
                        return;
                    }
                    
                    const transaction = db.transaction(['data'], 'readonly');
                    const store = transaction.objectStore('data');
                    const getRequest = store.get('appData');
                    
                    getRequest.onsuccess = () => {
                        if (getRequest.result) {
                            const { id, lastUpdated, ...data } = getRequest.result;
                            resolve(data);
                        } else {
                            resolve(null);
                        }
                    };
                    getRequest.onerror = () => resolve(null);
                };
                
                request.onupgradeneeded = (event) => {
                    const db = event.target.result;
                    if (!db.objectStoreNames.contains('data')) {
                        db.createObjectStore('data', { keyPath: 'id' });
                    }
                };
            });
        }

        function openExcelImportModal() {
            showToast('Ø§Ø³ØªÙŠØ±Ø§Ø¯ Excel - Ù‚ÙŠØ¯ Ø§Ù„ØªØ·ÙˆÙŠØ±', 'info');
        }

        // Initialize
        loadCompanies();
    </script>
</body>
</html>